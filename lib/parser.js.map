{"version":3,"sources":["../src/parser.js"],"names":["opMap","simpleTypes","complexTypes","kinds","andOrRe","ncnameRe","RegExp","EOF","String","fromCharCode","tpl","t","v","o","openParen","comma","closeParen","openCurly","closeCurly","openTag","qname","attrs","n","a","closeTag","seq","handleInfix","state","d","r","lastv","i","infix","bm","cur","unmark","mark","peek","test","close","movePreviousSibling","insertAfter","openBefore","close2","moveNextSibling","pop","push","insertBefore","arg2","moveLastChild","process","depth","ws","hasTag","last","lastChild","call","open","xml","cd","isEmpty","x","Triply","nextSibling","firstChild","includes","prev","previous","previousSibling","hasOwnProperty","unaryOp","v1","mappedOp","replace","lastItem","charReducer","next","char","undefined","emit","oldType","type","oldComment","comment","buffer","oldString","string","zero","number","b","tmp","trie","path","match","Array","isArray","length","_k","trie2","_v","isVar","stop","flag","lastQname","line","column","newline","ops","toRdl","$o","entry","s","k","toL3","ret","$t","$v","concat","tokenize","$chars","Observable","create","subscribe","complete","initLexerState","lex","props","$tpls","rdl","src","Error","moveRoot","traverse","initTokenState","parse","pipe","chunk","toString","parseString","str"],"mappings":"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","sourcesContent":["import { Observable, from } from \"rxjs\";\r\nimport { mergeMap } from \"rxjs/operators\";\r\nimport { find } from \"./trie\";\r\nimport { reduce, reduceAhead } from \"./rich-reducers\";\r\nimport { fromReadStream } from \"./node-stream\";\r\nimport Triply from \"triply\";\r\nimport { trie as ops } from \"./operator-trie\";\r\n\r\nconst opMap = {\r\n\t119: \"rest-params\",\r\n\t505: \"ggt\",\r\n\t507: \"glt\",\r\n\t509: \"geq\",\r\n\t801: \"subtract\",\r\n\t802: \"add\",\r\n\t600: \"concat\",\r\n\t903: \"divide\",\r\n\t904: \"multiply\",\r\n\t1701: \"minus\",\r\n\t1702: \"plus\",\r\n\t5005: \"maybe\",\r\n\t3904: \"any\",\r\n\t3802: \"many\",\r\n\t2005: \"$_\",\r\n\t1500: \"cast-as\"\r\n};\r\n\r\nconst simpleTypes = [\r\n\t\"item\",\r\n\t\"atomic\",\r\n\t\"string\",\r\n\t\"numeric\",\r\n\t\"integer\",\r\n\t\"number\",\r\n\t\"double\",\r\n\t\"decimal\",\r\n\t\"float\"\r\n];\r\n\r\nconst complexTypes = [\r\n\t\"function\",\r\n\t\"array\",\r\n\t\"map\"\r\n];\r\n\r\nconst kinds = [\r\n\t\"document-node\",\r\n\t\"element\",\r\n\t\"attribute\",\r\n\t\"processing-instruction\",\r\n\t\"comment\",\r\n\t\"text\",\r\n\t\"node\"\r\n];\r\n\r\nconst andOrRe = /^(n:)?(and|or)$/;\r\n\r\nconst ncnameRe = new RegExp(\"[\\\\p{L}\\\\p{N}_-]\",\"u\");\r\n\r\nconst EOF = String.fromCharCode(25);\r\n\r\nconst tpl = (t,v,o) => { return {t:t,v:v,o:o}; };\r\n\r\nconst openParen = () => tpl(1,1,\"(\");\r\n\r\nconst comma = () => tpl(3,100,\",\");\r\n\r\nconst closeParen = () => tpl(2,2,\")\");\r\n\r\nconst openCurly = () => tpl(1,3,\"{\");\r\n\r\nconst closeCurly = () => tpl(2,4,\"}\");\r\n\r\nconst openTag = (qname,attrs) => {\r\n\tconst n = tpl(11,qname);\r\n\tn.a = attrs;\r\n\treturn n;\r\n};\r\n\r\nconst closeTag = qname => tpl(12,qname);\r\n\r\nconst seq = () => tpl(6,\"\");\r\n\r\n/*\r\nconst log = r => reduce(Triply.traverse(r._root),(a,x) => {\r\n\tconst n = Triply.view(x.$0 == 3 ? x.$3 : x,1);\r\n\tn.is = x.$0 === 1 ? \"LEAF\" : x.$0 === 3 ? \"CLOSE\" : \"BRANCH\";\r\n\tconsole.log(n);\r\n\treturn a;\r\n});\r\n*/\r\n\r\n/*\r\nconst incr = a => a.map(x => {\r\n\tx.d++;\r\n\treturn x;\r\n});\r\n           (x)\r\n    $  --- /$ - , 2 - ) on close, nest:\r\n   /                      \\       mark call again\r\ncall                       /call - , 3 ) on close, nest\r\n*/\r\nfunction handleInfix(state,d) {\r\n\tconst r = state.r;\r\n\tlet lastv;\r\n\tfor(let i = state.infix[d] - 1; i >= 0; i--) {\r\n\t\t// handle each mark\r\n\t\t// mark again so we can peek\r\n\t\tconst bm = d+\":\"+i;\r\n\t\tconst cur = r.unmark(bm).mark(bm).peek();\r\n\t\t// treat and/or\r\n\t\tif(andOrRe.test(cur.o)) {\r\n\t\t\t// wrap the first arg\r\n\t\t\tconst close = r.movePreviousSibling().insertAfter(closeCurly()).peek();\r\n\t\t\tr.movePreviousSibling().openBefore(openCurly(),close);\r\n\t\t\tr.unmark(bm).mark(bm);\r\n\t\t\t// wrap the snd arg\r\n\t\t\tconst close2 = r.moveNextSibling().insertAfter(closeCurly()).peek();\r\n\t\t\tr.movePreviousSibling().openBefore(openCurly(),close2);\r\n\t\t\tr.unmark(bm).mark(bm);\r\n\t\t}\r\n\t\t// normal case: last preceeds\r\n\t\tif(!lastv || lastv > cur.v) {\r\n\t\t\t// move to 2nd arg, insert closing paren, peek\r\n\t\t\tr.pop();\r\n\t\t\tif(cur.v > 900) {\r\n\t\t\t\tconst close = r.moveNextSibling().push(closeParen()).peek();\r\n\t\t\t\tr.movePreviousSibling().insertBefore(openParen());\r\n\t\t\t\tr.openBefore(cur,close);\r\n\t\t\t\tr.unmark(bm);\r\n\t\t\t} else {\r\n\t\t\t\tr.push(comma());\r\n\t\t\t\tconst close = r.moveNextSibling().push(closeParen()).peek();\r\n\t\t\t\tr.unmark(bm);\r\n\t\t\t\tr.movePreviousSibling().insertBefore(openParen());\r\n\t\t\t\tr.openBefore(cur,close);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// remove the operator\r\n\t\t\tr.pop();\r\n\t\t\t// move to the second arg\r\n\t\t\tr.moveNextSibling();\r\n\t\t\t// remove the second argument of this operator\r\n\t\t\tconst arg2 = r.pop();\r\n\t\t\t// move to the previous operator that's already processed\r\n\t\t\t// go into the second argument and wrap it\r\n\t\t\t// move to before the closing paren\r\n\t\t\t//r.unmark(\"OP\");\r\n\t\t\tif(cur.v > 900) {\r\n\t\t\t\tconst close = r.moveNextSibling().push(closeParen()).peek();\r\n\t\t\t\tr.movePreviousSibling().insertBefore(openParen());\r\n\t\t\t\tr.openBefore(cur,close);\r\n\t\t\t} else {\r\n\t\t\t\tr.movePreviousSibling().moveLastChild().movePreviousSibling();\r\n\t\t\t\tconst close = r.push(comma()).push(arg2).push(closeParen()).peek();\r\n\t\t\t\tr.movePreviousSibling().movePreviousSibling().movePreviousSibling();\r\n\t\t\t\tr.insertBefore(openParen()).openBefore(cur,close);//.moveLastChild();\r\n\t\t\t\t// insert open parent, open and add the operator\r\n\t\t\t\t// add comma, the second arg and closing paren\r\n\t\t\t}\r\n\t\t\tr.unmark(bm);\r\n\t\t}\r\n\t\tlastv = cur.v;\r\n\t\t//Object.assign(cur,comma());\r\n\t}\r\n\r\n}\r\n\r\n// NOTE whitespace is ignored by the lexer, but it is in the state\r\nfunction process(tpl,state) {\r\n\tconst t = tpl.t, v = tpl.v, r = state.r;\r\n\tconst d = state.depth;\r\n\t// reset WS every time\r\n\tconst ws = state.ws;\r\n\tconst hasTag = state.hasTag;\r\n\t//console.log(t,v,ws,hasTag);\r\n\tstate.ws = false;\r\n\tstate.hasTag = 0;\r\n\t//console.log(t,v,tpl.o);\r\n\tif(t == 1) {\r\n\t\tif(v == 1) {\r\n\t\t\tconst last = r.lastChild();\r\n\t\t\tif(last && last.t === 2 && last.v == 2) {\r\n\t\t\t\t// 1. mark call\r\n\t\t\t\tstate.call[d] = true;\r\n\t\t\t\t//console.log(\"opencall\",d,_strip(r.peek()));\r\n\t\t\t\t// nest entire tree\r\n\t\t\t\t// 2. push comma\r\n\t\t\t\t// TODO add original position to comma\r\n\t\t\t\tr.mark(\"call\"+d).push(comma());\r\n\t\t\t} else {\r\n\t\t\t\tconst cur = r.peek();\r\n\t\t\t\tif(v == 1 && cur.t !== 6 && cur.t !== 10 && !(cur.t == 4 && (cur.v < 300 || cur.v > 2000))) {\r\n\t\t\t\t\t//console.log(cur.t,cur.v,cur.o);\r\n\t\t\t\t\tr.push(seq());\r\n\t\t\t\t}\r\n\t\t\t\tr.open(tpl);\r\n\t\t\t}\r\n\t\t} else if(v == 3 && state.xml) {\r\n\t\t\tr.open(tpl);\r\n\t\t} else {\r\n\t\t\tr.open(tpl);\r\n\t\t}\r\n\t} else if(t == 2) {\r\n\t\t// FIXME treat all infix-ops in same depth, not just on close\r\n\t\tstate.r.push(tpl).close();\r\n\t\tconst cd = d - 1;\r\n\t\tif(state.call[cd]) {\r\n\t\t\t// $(x)(2) => call($(x),2)\r\n\t\t\tstate.call[cd] = false;\r\n\t\t\t//console.log(\"call\",r.peek());\r\n\t\t\tr.unmark(\"call\"+cd).insertBefore(openParen()).openBefore({t:6,v:\"call\"}).close();\r\n\t\t}\r\n\t\t/*\r\n\t\t* 1 * 2 + 3\r\n\t\t* mult(1,2) + 3\r\n\t\t* 1 + 2 * 3\r\n\t\t* add(1,2) * 3 => pre, so nest in last\r\n\t\t* add(1,2 * 3))\r\n\t\t* add(1,mult(2,3)) => pre, so next in last (we're in subs, so openBefore )\r\n\t\t */\r\n\t\tif(state.infix[d]) {\r\n\t\t\t//console.log(\"peek-close\",_strip(r.peek()));\r\n\t\t\t// mark close so we can return to it\r\n\t\t\tr.mark(\"close\");\r\n\t\t\thandleInfix(state,d);\r\n\t\t\tr.unmark(\"close\");\r\n\t\t\tstate.infix[d] = null;\r\n\t\t}\r\n\t} else if(t == 4){\r\n\t\tif(v == 802 || v == 904 || v == 2005) {\r\n\t\t\tconst last = r.peek();\r\n\t\t\tconst test = last && (last.o || last.v);\r\n\t\t\tconst isEmpty = x => x && Triply.nextSibling(Triply.firstChild(x)) == Triply.lastChild(x);\r\n\t\t\tif(test && ((simpleTypes.includes(test) && isEmpty(last)) || complexTypes.includes(test) || kinds.includes(test))) {\r\n\t\t\t\ttpl.o = opMap[ v + 3000];\r\n\t\t\t\tstate.r.insertAfter(closeParen()).movePreviousSibling().insertBefore(openParen()).openBefore(tpl);\r\n\t\t\t\treturn state;\r\n\t\t\t} else if(last.t == 1 && last.v == 1) {\r\n\t\t\t\tconst prev = r.previous();\r\n\t\t\t\tconst test = prev && prev.o;\r\n\t\t\t\tif(test && complexTypes.includes(test)) {\r\n\t\t\t\t\tif(test == \"function\") {\r\n\t\t\t\t\t\t// convert function(*) to function((...),item()*)\r\n\t\t\t\t\t\tstate.r.push(seq()).open(openParen())\r\n\t\t\t\t\t\t\t.push({t:4,o:\"rest-params\"}).open(openParen()).push(closeParen()).close()\r\n\t\t\t\t\t\t\t.push(closeParen()).close().push(closeParen()).close()\r\n\t\t\t\t\t\t\t.push({t:4,o:\"any\"}).open(openParen()).push({t:4,o:\"item\"}).open(openParen()).push(closeParen()).close()\r\n\t\t\t\t\t\t\t.push(closeParen()).close();\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(v == 505 && hasTag) {\r\n\t\t\t// TODO replace with tag and flag XML at depth\r\n\t\t\tr.pop();\r\n\t\t\tconst qname = state.qname;\r\n\t\t\tstate.qname = null;\r\n\t\t\tif(hasTag == 1) {\r\n\t\t\t\tr.push(openTag(qname,state.attrs));\r\n\t\t\t\tstate.xml++;\r\n\t\t\t\tstate.attrs = [];\r\n\t\t\t} else if(hasTag == 3 || hasTag == 6) {\r\n\t\t\t\tr.push(closeTag(qname));//.close();\r\n\t\t\t}\r\n\t\t\tstate.infix[d]--;\r\n\t\t\treturn state;\r\n\t\t} else if(v == 1901) {\r\n\t\t\tconst last = r.peek();\r\n\t\t\tif(last.t == 4 && last.v == 507) {\r\n\t\t\t\t// close tag\r\n\t\t\t\tif(hasTag) {\r\n\t\t\t\t\tconst qname = state.qname;\r\n\t\t\t\t\tr.pop();\r\n\t\t\t\t\tr.push(openTag(qname,state.attrs));\r\n\t\t\t\t\tr.push(tpl);\r\n\t\t\t\t\tstate.attrs = [];\r\n\t\t\t\t}\r\n\t\t\t\tstate.hasTag = hasTag + 2;\r\n\t\t\t\treturn state;\r\n\t\t\t}\r\n\t\t} else if(v == 2600) {\r\n\t\t\tconst prev = r.previousSibling();\r\n\t\t\tif(prev && prev.t == 1 && prev.v == 3) {\r\n\t\t\t\tprev.v += 2000;\r\n\t\t\t}\r\n\t\t\tconst last = r.peek(1);\r\n\t\t\tr.pop();\r\n\t\t\ttpl.o = last.v;\r\n\t\t} else if(v == 509 && hasTag == 5) {\r\n\t\t\t// NOTE treat attrs as pairs\r\n\t\t\tstate.hasTag = hasTag + 1;\r\n\t\t\treturn state;\r\n\t\t}\r\n\t\tif(v == 119 || v == 2005) {\r\n\t\t\tif(opMap.hasOwnProperty(v)) tpl.o = opMap[v];\r\n\t\t\tr.push(tpl).open(openParen()).push(closeParen()).close();\r\n\t\t} else if(v >= 300 && v < 2000) {\r\n\t\t\t// NOTE always add prefix to distinguish between infix operators and equivalent functions\r\n\t\t\tconst last = r.peek();\r\n\t\t\tconst unaryOp = (v == 801 || v == 802) && (!last || !last.t || last.t == 1 || last.t == 4);\r\n\t\t\tconst v1 = unaryOp ? v + 900 : v;\r\n\t\t\ttpl.v = v1;\r\n\t\t\tconst mappedOp = opMap.hasOwnProperty(v1) ? opMap[v1] : \"n:\"+tpl.o;\r\n\t\t\ttpl.o = mappedOp;\r\n\t\t\tr.push(tpl);\r\n\t\t\tif(!state.infix[d]) state.infix[d] = 0;\r\n\t\t\tr.mark(d+\":\"+state.infix[d]++);\r\n\t\t} else {\r\n\t\t\tr.push(tpl);\r\n\t\t}\r\n\t} else if(t == 6) {\r\n\t\tif(/^\\$/.test(v)) {\r\n\t\t\t// var\r\n\t\t\ttpl.v = v.replace(/^\\$/,\"\");\r\n\t\t\tif(/[0-9]/.test(tpl.v)) tpl.t = 8;\r\n\t\t\tr.push({t:10,v:\"$\",o:\"$\"}).open(openParen()).push(tpl).push(closeParen()).close();\r\n\t\t} else {\r\n\t\t\tconst last = r.peek();\r\n\t\t\tif(last.t == 4 && last.v == 507 && !ws) {\r\n\t\t\t\tstate.qname = v;\r\n\t\t\t\tstate.hasTag = hasTag + 1;\r\n\t\t\t\treturn state;\r\n\t\t\t} else if(hasTag == 4) {\r\n\t\t\t\tstate.hasTag = hasTag + 1;\r\n\t\t\t\tif(!state.attrs) state.attrs = [];\r\n\t\t\t\tstate.attrs.push([v]);\r\n\t\t\t} else {\r\n\t\t\t\tr.push(tpl);\r\n\t\t\t}\r\n\t\t}\r\n\t} else if(t === 0) {\r\n\t\tr.push(tpl);\r\n\t\tif(state.infix[d]) {\r\n\t\t\t// mark close so we can return to it\r\n\t\t\tr.mark(\"EOS\");\r\n\t\t\thandleInfix(state,d);\r\n\t\t\tr.unmark(\"EOS\");\r\n\t\t\tstate.infix[d] = null;\r\n\t\t}\r\n\t} else if(t === 17){\r\n\t\t// mark WS\r\n\t\tstate.ws = true;\r\n\t\tif(hasTag) state.hasTag = 4;\r\n\t} else {\r\n\t\tif(hasTag == 6) {\r\n\t\t\tstate.attrs.lastItem.push(v);\r\n\t\t\tstate.hasTag = 1;\r\n\t\t} else {\r\n\t\t\tr.push(tpl);\r\n\t\t}\r\n\t}\r\n\tstate.depth = tpl.d;\r\n\treturn state;\r\n}\r\n\r\nfunction charReducer(state,next) {\r\n\tconst char = state.char;\r\n\tif(char === undefined) {\r\n\t\tstate.emit = void 0;\r\n\t\tstate.char = next;\r\n\t\treturn state;\r\n\t}\r\n\tif(char == EOF) {\r\n\t\tstate.emit = state.emit && state.tpl.t == 0 ? void 0 : {t:0, v:0, o:EOF};\r\n\t\treturn state;\r\n\t}\r\n\tconst oldType = state.type;\r\n\tconst oldComment = state.comment;\r\n\tconst buffer = state.buffer;\r\n\tconst oldString = state.string;\r\n\t//const oldTpl = state.tpl;\r\n\tconst zero = oldComment || state.qname || state.number ? false : oldString === 0;\r\n\tconst b = buffer + char;\r\n\tconst tmp = zero ? find(state.trie,char,b,state.path) : [[],[]];\r\n\tconst trie = tmp[0];\r\n\tconst path = tmp[1];\r\n\tlet match = 0;\r\n\tif(!trie) {\r\n\t\tmatch = 2;\r\n\t} else if(Array.isArray(trie)) {\r\n\t\tmatch = !trie.length ? 2 : trie[0]._k === b ? 3 : 0;\r\n\t} else if(\"_k\" in trie) {\r\n\t\tmatch = trie._k === b ? 1 : (path.length > 0 && path[0]._k === b) ? 5 : 0;\r\n\t}\r\n\tif(match !== 2) {\r\n\t\tconst tmp = find(trie,next,b + next,[...path]);\r\n\t\tconst trie2 = tmp[0];\r\n\t\tif(trie2 && ((Array.isArray(trie2) && trie2.length > 0) || \"_k\" in trie2)) {\r\n\t\t\t// still a match, stop this one\r\n\t\t\tmatch = 0;\r\n\t\t} else if(match == 3) {\r\n\t\t\t// don't match if char and next ncname\r\n\t\t\tif(trie[0]._v > 4 && ncnameRe.test(char) && ncnameRe.test(next)) {\r\n\t\t\t\tmatch = 2;\r\n\t\t\t}\r\n\t\t\t//match = 0;\r\n\t\t} else if(match === 0) {\r\n\t\t\t// next won't match, so neither will this\r\n\t\t\tmatch = 2;\r\n\t\t}\r\n\t}\r\n\t// NOTE hack for qnames with dash\r\n\tif(next == \"-\" && match == 1 && ncnameRe.test(char)) {\r\n\t\tmatch = 0;\r\n\t}\r\n\tlet type;\r\n\t// skip anything but closers\r\n\tif(match == 1) {\r\n\t\ttype = trie._v;\r\n\t} else if(match == 3) {\r\n\t\ttype = trie[0]._v;\r\n\t} else if(match == 5) {\r\n\t\ttype = path[0]._v;\r\n\t} else if(/\\s/.test(char)) {\r\n\t\ttype = 10;\r\n\t} else if(/[0-9]/.test(char)) {\r\n\t\ttype = 11;\r\n\t} else if(/[a-zA-Z]/.test(char)) {\r\n\t\ttype = 12;\r\n\t} else {\r\n\t\ttype = 0;\r\n\t}\r\n\tconst isVar = (type == 9 && next != \"(\");\r\n\tif(isVar) {\r\n\t\tmatch = type = 0;\r\n\t}\r\n\tlet number = (zero && (type == 11 || (type == 8 && oldType != 8 && /[0-9]/.test(next)))) || (state.number && (type === 0 || type == 11));\r\n\tlet qname = (zero && !number && type != 10 && match == 2) || (state.qname && type != 10) || isVar;\r\n\tlet stop = (qname && /[^a-zA-Z0-9\\-_:]/.test(next)) || (number && /[^0-9.]/.test(next));\r\n\tlet flag;\r\n\tif(number || qname) {\r\n\t\tflag = 0;\r\n\t} else if(zero) {\r\n\t\tif(type == 6 || type == 7) {\r\n\t\t\tflag = 1; // open string :)\r\n\t\t} else if(type == 2501) {\r\n\t\t\tflag = 3; // open comment :)\r\n\t\t\t//} else if(type == 3 && oldType != 3 && next != \"{\" && opencount[0] > 0) then\r\n\t\t\t//    11 (: open enc-expr, TODO add double curly to TRIE :)\r\n\t\t\t//else if($enc-expr and $type == 4 and $has-quot == 0 and $next ne \"}\") then\r\n\t\t\t//    12 (: close enc-expr, TODO add double curly to TRIE :)\r\n\t\t} else {\r\n\t\t\tflag = 0;\r\n\t\t}\r\n\t} else {\r\n\t\t// for the parser we need at least to escape a single quote char, but it should be handled by the trie :)\r\n\t\tif((oldString == 6 && char == \"\\\"\" && next !== \"\\\"\") || (oldString == 7 && char == \"'\")) {\r\n\t\t\tflag = 2; //(: close string :)\r\n\t\t} else if(oldComment && char == \":\" && next == \")\") {\r\n\t\t\tflag = 4; //(: close comment :)\r\n\t\t\t//else if($attrkey == false() and empty($type) and head($opencount) gt 0) then\r\n\t\t\t//    9\r\n\t\t\t//else if($attrkey and $type == 509 and head($opencount) gt 0) then\r\n\t\t\t//    10\r\n\t\t} else {\r\n\t\t\tflag = 0;\r\n\t\t}\r\n\t}\r\n\tlet tpl;\r\n\tif(!flag) {\r\n\t\tif(stop && type != 9) {\r\n\t\t\ttpl = {t:number ? 8 : 6,v:b};\r\n\t\t} else if(number && type == 8) {\r\n\t\t\t// continue\r\n\t\t} else if(type == 10 && state.type !== 10) {\r\n\t\t\ttpl = {t:17};\r\n\t\t} else if(match != 2 && match !== 0) {\r\n\t\t\tlet t = type == 1 || type == 3 || type == 2001 ? 1 :\r\n\t\t\t\ttype == 2 || type == 4 || type == 2002 ? 2 :\r\n\t\t\t\t\ttype == 100 ? 3 :\r\n\t\t\t\t\t\ttype == 5 ? 0 :\r\n\t\t\t\t\t\t\ttype == 9 ? 10 :\r\n\t\t\t\t\t\t\t\ttype == 8 ? 13 :\r\n\t\t\t\t\t\t\t\t\t4;\r\n\t\t\ttpl = {t:t,v:type,o:b};\r\n\t\t}\r\n\t} else if(flag == 2 || flag == 4) {\r\n\t\ttpl = {t:flag == 2 ? 7 : 9,v:buffer};\r\n\t}\r\n\t// if the result is an array, it was expanded\r\n\t// in this case, emit will be overridden by process...\r\n\t// we should only just buffer 2 levels of depth:\r\n\t// one for the type and one for the occurrence indicator...\r\n\tif((zero && type == 10 && buffer == \"\") || tpl || flag) {\r\n\t\tstate.buffer = \"\";\r\n\t} else {\r\n\t\tstate.buffer = b;\r\n\t}\r\n\tif(qname) state.lastQname = tpl;\r\n\t// FIXME hack to skip a char\r\n\tstate.char = flag == 4 ? void 0 : next;\r\n\tstate.number = number && !stop;\r\n\tstate.qname = qname && !stop;\r\n\tstate.type = type;\r\n\tif(tpl) {\r\n\t\ttpl.line = state.line;\r\n\t\ttpl.column = state.column;\r\n\t\tstate.tpl = tpl;\r\n\t}\r\n\tstate.emit = tpl;\r\n\tlet newline = false;\r\n\tif(char == \"\\n\") newline = true;\r\n\tif(newline) {\r\n\t\tstate.line++;\r\n\t\tstate.column = 1;\r\n\t} else {\r\n\t\tstate.column++;\r\n\t}\r\n\r\n\tstate.trie = match > 0 ? ops : trie;\r\n\tstate.path = match > 0 ? [] : path;\r\n\tif(flag == 1) {\r\n\t\tstate.string = type;\r\n\t} else if(flag == 2) {\r\n\t\tstate.string = 0;\r\n\t} else if(flag == 3) {\r\n\t\tstate.comment = true;\r\n\t} else if(flag == 4) {\r\n\t\tstate.comment = false;\r\n\t}\r\n\treturn state;\r\n}\r\n\r\nfunction toRdl($o,entry) {\r\n\tconst { t, v, o } = entry;\r\n\tif(t === 0) {\r\n\t\t$o.next(o === EOF ? \"\" : \";\\n\\n\");\r\n\t} else if(t == 7) {\r\n\t\t$o.next(`\"${v}\"`);\r\n\t} else if(t == 6 || t == 8) {\r\n\t\t$o.next(v);\r\n\t} else if(t == 9) {\r\n\t\t$o.next(\"(:\"+v+\":)\");\r\n\t} else if(t == 11) {\r\n\t\tlet s = \"<\"+v;\r\n\t\tfor(let [k,v] of entry.a) {\r\n\t\t\ts += \" \"+k+\"=\\\"\"+v+\"\\\"\";\r\n\t\t}\r\n\t\ts += \">\";\r\n\t\t//s += next.t == 12 ? \"/>\" : \">\";\r\n\t\t$o.next(s);\r\n\t} else if(t == 12) {\r\n\t\t$o.next(\"</\"+v+\">\");\r\n\t} else if(t == 4 && v == 2600) {\r\n\t\t$o.next(\"\\\"\"+o+\"\\\":\");\r\n\t} else if(o){\r\n\t\t$o.next(o);\r\n\t}\r\n\treturn $o;\r\n}\r\n\r\n\r\nfunction toL3(ret,entry,next){\r\n\tlet $t = entry.t;\r\n\tlet $v = entry.v;\r\n\tlet r = [];\r\n\tif($t == 1) {\r\n\t\tif($v == 3) {\r\n\t\t\tr = [15];\r\n\t\t} else if($v == 2001) {\r\n\t\t\tr = [5];\r\n\t\t} else if($v == 2003) {\r\n\t\t\tr = [6];\r\n\t\t}\r\n\t} else if($t == 2) {\r\n\t\tr = [17];\r\n\t} else if($t == 7) {\r\n\t\tr = [3,$v];\r\n\t} else if($t == 8) {\r\n\t\tif(/^\\./.test($v)) $v = \"0\" + $v;\r\n\t\tr = [12,$v];\r\n\t} else if($t == 6) {\r\n\t\tif(/#[0-9]$/.test($v)) {\r\n\t\t\tr = [4,$v+\"\"];\r\n\t\t} else {\r\n\t\t\tr = next && next.t == 1 && next.v == 1 ? [14,$v] : [3,$v];\r\n\t\t}\r\n\t} else if($t == 4 || $t == 10) {\r\n\t\tif($v == 2600) {\r\n\t\t\tr = [2,entry.o];\r\n\t\t} else {\r\n\t\t\tr = [14,entry.o];\r\n\t\t}\r\n\t} else if($t == 5) {\r\n\t\tr = [3,$v];\r\n\t} else if($t == 9) {\r\n\t\tr = [8,$v];\r\n\t} else if($t == 11) {\r\n\t\tr = [1,$v];\r\n\t\tfor(let [k,v] of entry.a) {\r\n\t\t\tr = r.concat([2,k,3,v]);\r\n\t\t}\r\n\t} else if($t == 12) {\r\n\t\tr = [17];\r\n\t} else if($t == 13) {\r\n\t\tr = [14,\"$.\",17];\r\n\t}\r\n\t//return r ? ret.concat(r) : ret;//Observable.from(r) : Observable.empty();\r\n\tfor(let a of r) ret.next(a);\r\n\treturn ret;\r\n}\r\n\r\nexport const tokenize = state => $chars => {\r\n\treturn Observable.create($o => {\r\n\t\t$chars.subscribe({\r\n\t\t\tnext(cur) {\r\n\t\t\t\tcharReducer(state,cur);\r\n\t\t\t\tif(state.emit) {\r\n\t\t\t\t\t//console.log(state.emit);\r\n\t\t\t\t\t$o.next(state.emit);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcomplete() {\r\n\t\t\t\tcharReducer(state,EOF);\r\n\t\t\t\tif(state.emit) $o.next(state.emit);\r\n\t\t\t\tcharReducer(state);\r\n\t\t\t\tif(state.emit) $o.next(state.emit);\r\n\t\t\t\t$o.complete();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\t//return $chars.scan((state,cur) => charReducer(state,cur),state).filter(state => state.emit).map(state => state.emit);\r\n};\r\n\r\nconst initLexerState = () => {\r\n\treturn {\r\n\t\temit:false,\r\n\t\tdepth:0,\r\n\t\tr:new Triply(),\r\n\t\tcall:[],\r\n\t\tinfix:[],\r\n\t\txml:0,\r\n\t\tattrs:[],\r\n\t\tws:false,\r\n\t\thasTag:0,\r\n\t\tqname:null\r\n\t};\r\n};\r\n\r\nexport const lex = props => $tpls => {\r\n\tconst rdl = props.rdl;\r\n\tconst src = props.src;\r\n\tlet state = initLexerState();\r\n\treturn Observable.create($o => {\r\n\t\t$tpls.subscribe({\r\n\t\t\tnext(tpl){\r\n\t\t\t\tconst r = state.r;\r\n\t\t\t\tlet depth = state.depth;\r\n\t\t\t\tif(tpl.t == 2) {\r\n\t\t\t\t\tdepth--;\r\n\t\t\t\t\tif(depth < 0) {\r\n\t\t\t\t\t\tthrow new Error(\"Incorrect depth of close\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!state.tpl || state.tpl.t == 3) throw new Error(\"Incorrect position of close\");\r\n\t\t\t\t} else if(tpl.t == 1) {\r\n\t\t\t\t\t//state.i[depth] = r.length;\r\n\t\t\t\t\tdepth++;\r\n\t\t\t\t}\r\n\t\t\t\ttpl.d = depth;\r\n\t\t\t\t//console.log(depth,tpl);\r\n\t\t\t\tstate = process(tpl,state);\r\n\t\t\t\tstate.tpl = tpl;\r\n\t\t\t\t// never emit tpl, oldTpl can be overriden\r\n\t\t\t\tif(tpl.t === 0) {\r\n\t\t\t\t\tif(depth !== 0){\r\n\t\t\t\t\t\t//console.log(tpl);\r\n\t\t\t\t\t\tthrow new Error(\"Incorrect depth at EOF\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//log(r);\r\n\t\t\t\t\tr.moveRoot().pop();\r\n\t\t\t\t\tif(src) {\r\n\t\t\t\t\t\treturn reduce(r.traverse(true),(a,x) => {\r\n\t\t\t\t\t\t\ta.next(x);\r\n\t\t\t\t\t\t\treturn a;\r\n\t\t\t\t\t\t},$o);\r\n\t\t\t\t\t} else if(rdl) {\r\n\t\t\t\t\t\treduceAhead(r.traverse(),toRdl,$o);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treduceAhead(r.traverse(),toL3,$o);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tstate.r = new Triply();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcomplete(){\r\n\t\t\t\t$o.complete();\r\n\t\t\t}});\r\n\t});\r\n};\r\n\r\nexport const initTokenState = () => {\r\n\treturn {\r\n\t\ttype:0,\r\n\t\tbuffer:\"\",\r\n\t\tstring:0,\r\n\t\tflag:0,\r\n\t\ttrie:ops,\r\n\t\tnumber:false,\r\n\t\tcomment:false,\r\n\t\tqname: false,\r\n\t\tline: 1,\r\n\t\tcolumn: 1,\r\n\t\tpath: [],\r\n\t\ttpl: {},\r\n\t\temit:void 0\r\n\t};\r\n};\r\n\r\nexport const parse = (path,props = {}) => fromReadStream(path).pipe(mergeMap(chunk => from(chunk.toString())),tokenize(initTokenState()),lex(props));\r\n\r\nexport const parseString = (str,props = {}) => from(str).pipe(tokenize(initTokenState()),lex(props));\r\n"],"file":"parser.js"}