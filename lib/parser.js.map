{"version":3,"sources":["../src/parser.js"],"names":["ops","require","opMap","simpleTypes","complexTypes","kinds","andOrRe","ncnameRe","RegExp","EOF","String","fromCharCode","tpl","t","v","o","openParen","comma","closeParen","openCurly","closeCurly","openTag","qname","attrs","n","a","closeTag","seq","log","r","Triply","traverse","_root","x","view","$0","$3","is","console","handleInfix","state","d","lastv","i","infix","bm","cur","unmark","mark","peek","test","close","movePreviousSibling","insertAfter","openBefore","close2","moveNextSibling","pop","push","insertBefore","arg2","moveLastChild","process","depth","ws","hasTag","last","lastChild","call","open","xml","cd","isEmpty","nextSibling","firstChild","includes","prev","previous","previousSibling","hasOwnProperty","unaryOp","v1","mappedOp","replace","lastItem","charReducer","next","char","undefined","emit","oldType","type","oldComment","comment","buffer","oldString","string","zero","number","b","tmp","trie","path","match","Array","isArray","length","_k","trie2","_v","isVar","stop","flag","lastQname","line","column","newline","toRdl","$o","entry","s","k","toL3","ret","$t","$v","concat","tokenize","$chars","Observable","create","subscribe","complete","initLexerState","lex","props","$tpls","rdl","src","Error","moveRoot","initTokenState","parse","pipe","chunk","toString","parseString","str"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;AAEA,MAAMA,MAAMC,QAAQ,uBAAR,CAAZ;;AAEA,MAAMC,QAAQ;AACb,OAAK,aADQ;AAEb,OAAK,KAFQ;AAGb,OAAK,KAHQ;AAIb,OAAK,KAJQ;AAKb,OAAK,UALQ;AAMb,OAAK,KANQ;AAOb,OAAK,QAPQ;AAQb,OAAK,UARQ;AASb,QAAM,OATO;AAUb,QAAM,MAVO;AAWb,QAAM,OAXO;AAYb,QAAM,KAZO;AAab,QAAM,MAbO;AAcb,QAAM,IAdO;AAeb,QAAM;AAfO,CAAd;AAkBA,MAAMC,cAAc,CACnB,MADmB,EAEnB,QAFmB,EAGnB,QAHmB,EAInB,SAJmB,EAKnB,SALmB,EAMnB,QANmB,EAOnB,QAPmB,EAQnB,SARmB,EASnB,OATmB,CAApB;AAYA,MAAMC,eAAe,CACpB,UADoB,EAEpB,OAFoB,EAGpB,KAHoB,CAArB;AAMA,MAAMC,QAAQ,CACb,eADa,EAEb,SAFa,EAGb,WAHa,EAIb,wBAJa,EAKb,SALa,EAMb,MANa,EAOb,MAPa,CAAd;AAUA,MAAMC,UAAU,iBAAhB;AAEA,MAAMC,WAAW,IAAIC,MAAJ,CAAW,kBAAX,EAA8B,GAA9B,CAAjB;AAEA,MAAMC,MAAMC,OAAOC,YAAP,CAAoB,EAApB,CAAZ;;AAEA,MAAMC,MAAM,CAACC,CAAD,EAAGC,CAAH,EAAKC,CAAL,KAAW;AAAE,SAAO;AAACF,OAAEA,CAAH;AAAKC,OAAEA,CAAP;AAASC,OAAEA;AAAX,GAAP;AAAuB,CAAhD;;AAEA,MAAMC,YAAY,MAAMJ,IAAI,CAAJ,EAAM,CAAN,EAAQ,GAAR,CAAxB;;AAEA,MAAMK,QAAQ,MAAML,IAAI,CAAJ,EAAM,GAAN,EAAU,GAAV,CAApB;;AAEA,MAAMM,aAAa,MAAMN,IAAI,CAAJ,EAAM,CAAN,EAAQ,GAAR,CAAzB;;AAEA,MAAMO,YAAY,MAAMP,IAAI,CAAJ,EAAM,CAAN,EAAQ,GAAR,CAAxB;;AAEA,MAAMQ,aAAa,MAAMR,IAAI,CAAJ,EAAM,CAAN,EAAQ,GAAR,CAAzB;;AAEA,MAAMS,UAAU,CAACC,KAAD,EAAOC,KAAP,KAAiB;AAChC,QAAMC,IAAIZ,IAAI,EAAJ,EAAOU,KAAP,CAAV;AACAE,IAAEC,CAAF,GAAMF,KAAN;AACA,SAAOC,CAAP;AACA,CAJD;;AAMA,MAAME,WAAWJ,SAASV,IAAI,EAAJ,EAAOU,KAAP,CAA1B;;AAEA,MAAMK,MAAM,MAAMf,IAAI,CAAJ,EAAM,EAAN,CAAlB;;AAGA,MAAMgB,MAAMC,KAAK,0BAAOC,gBAAOC,QAAP,CAAgBF,EAAEG,KAAlB,CAAP,EAAgC,CAACP,CAAD,EAAGQ,CAAH,KAAS;AACzD,QAAMT,IAAIM,gBAAOI,IAAP,CAAYD,EAAEE,EAAF,IAAQ,CAAR,GAAYF,EAAEG,EAAd,GAAmBH,CAA/B,EAAiC,CAAjC,CAAV;;AACAT,IAAEa,EAAF,GAAOJ,EAAEE,EAAF,KAAS,CAAT,GAAa,MAAb,GAAsBF,EAAEE,EAAF,KAAS,CAAT,GAAa,OAAb,GAAuB,QAApD;AACAG,UAAQV,GAAR,CAAYJ,CAAZ;AACA,SAAOC,CAAP;AACA,CALgB,CAAjB;AAOA;;;;;;;;;;;;AAUA,SAASc,WAAT,CAAqBC,KAArB,EAA2BC,CAA3B,EAA8B;AAC7B,QAAMZ,IAAIW,MAAMX,CAAhB;AACA,MAAIa,KAAJ;;AACA,OAAI,IAAIC,IAAIH,MAAMI,KAAN,CAAYH,CAAZ,IAAiB,CAA7B,EAAgCE,KAAK,CAArC,EAAwCA,GAAxC,EAA6C;AAC5C;AACA;AACA,UAAME,KAAKJ,IAAE,GAAF,GAAME,CAAjB;AACA,UAAMG,MAAMjB,EAAEkB,MAAF,CAASF,EAAT,EAAaG,IAAb,CAAkBH,EAAlB,EAAsBI,IAAtB,EAAZ,CAJ4C,CAK5C;;AACA,QAAG3C,QAAQ4C,IAAR,CAAaJ,IAAI/B,CAAjB,CAAH,EAAwB;AACvB;AACA,YAAMoC,QAAQtB,EAAEuB,mBAAF,GAAwBC,WAAxB,CAAoCjC,YAApC,EAAkD6B,IAAlD,EAAd;AACApB,QAAEuB,mBAAF,GAAwBE,UAAxB,CAAmCnC,WAAnC,EAA+CgC,KAA/C;AACAtB,QAAEkB,MAAF,CAASF,EAAT,EAAaG,IAAb,CAAkBH,EAAlB,EAJuB,CAKvB;;AACA,YAAMU,SAAS1B,EAAE2B,eAAF,GAAoBH,WAApB,CAAgCjC,YAAhC,EAA8C6B,IAA9C,EAAf;AACApB,QAAEuB,mBAAF,GAAwBE,UAAxB,CAAmCnC,WAAnC,EAA+CoC,MAA/C;AACA1B,QAAEkB,MAAF,CAASF,EAAT,EAAaG,IAAb,CAAkBH,EAAlB;AACA,KAf2C,CAgB5C;;;AACA,QAAG,CAACH,KAAD,IAAUA,QAAQI,IAAIhC,CAAzB,EAA4B;AAC3B;AACAe,QAAE4B,GAAF;;AACA,UAAGX,IAAIhC,CAAJ,GAAQ,GAAX,EAAgB;AACf,cAAMqC,QAAQtB,EAAE2B,eAAF,GAAoBE,IAApB,CAAyBxC,YAAzB,EAAuC+B,IAAvC,EAAd;AACApB,UAAEuB,mBAAF,GAAwBO,YAAxB,CAAqC3C,WAArC;AACAa,UAAEyB,UAAF,CAAaR,GAAb,EAAiBK,KAAjB;AACAtB,UAAEkB,MAAF,CAASF,EAAT;AACA,OALD,MAKO;AACNhB,UAAE6B,IAAF,CAAOzC,OAAP;AACA,cAAMkC,QAAQtB,EAAE2B,eAAF,GAAoBE,IAApB,CAAyBxC,YAAzB,EAAuC+B,IAAvC,EAAd;AACApB,UAAEkB,MAAF,CAASF,EAAT;AACAhB,UAAEuB,mBAAF,GAAwBO,YAAxB,CAAqC3C,WAArC;AACAa,UAAEyB,UAAF,CAAaR,GAAb,EAAiBK,KAAjB;AACA;AACD,KAfD,MAeO;AACN;AACAtB,QAAE4B,GAAF,GAFM,CAGN;;AACA5B,QAAE2B,eAAF,GAJM,CAKN;;AACA,YAAMI,OAAO/B,EAAE4B,GAAF,EAAb,CANM,CAON;AACA;AACA;AACA;;AACA,UAAGX,IAAIhC,CAAJ,GAAQ,GAAX,EAAgB;AACf,cAAMqC,QAAQtB,EAAE2B,eAAF,GAAoBE,IAApB,CAAyBxC,YAAzB,EAAuC+B,IAAvC,EAAd;AACApB,UAAEuB,mBAAF,GAAwBO,YAAxB,CAAqC3C,WAArC;AACAa,UAAEyB,UAAF,CAAaR,GAAb,EAAiBK,KAAjB;AACA,OAJD,MAIO;AACNtB,UAAEuB,mBAAF,GAAwBS,aAAxB,GAAwCT,mBAAxC;AACA,cAAMD,QAAQtB,EAAE6B,IAAF,CAAOzC,OAAP,EAAgByC,IAAhB,CAAqBE,IAArB,EAA2BF,IAA3B,CAAgCxC,YAAhC,EAA8C+B,IAA9C,EAAd;AACApB,UAAEuB,mBAAF,GAAwBA,mBAAxB,GAA8CA,mBAA9C;AACAvB,UAAE8B,YAAF,CAAe3C,WAAf,EAA4BsC,UAA5B,CAAuCR,GAAvC,EAA2CK,KAA3C,EAJM,CAI4C;AAClD;AACA;AACA;;AACDtB,QAAEkB,MAAF,CAASF,EAAT;AACA;;AACDH,YAAQI,IAAIhC,CAAZ,CAzD4C,CA0D5C;AACA;AAED,C,CAED;;;AACA,SAASgD,OAAT,CAAiBlD,GAAjB,EAAqB4B,KAArB,EAA4B;AAC3B,QAAM3B,IAAID,IAAIC,CAAd;AAAA,QAAiBC,IAAIF,IAAIE,CAAzB;AAAA,QAA4Be,IAAIW,MAAMX,CAAtC;AACA,QAAMY,IAAID,MAAMuB,KAAhB,CAF2B,CAG3B;;AACA,QAAMC,KAAKxB,MAAMwB,EAAjB;AACA,QAAMC,SAASzB,MAAMyB,MAArB,CAL2B,CAM3B;;AACAzB,QAAMwB,EAAN,GAAW,KAAX;AACAxB,QAAMyB,MAAN,GAAe,CAAf,CAR2B,CAS3B;;AACA,MAAGpD,KAAK,CAAR,EAAW;AACV,QAAGC,KAAK,CAAR,EAAW;AACV,YAAMoD,OAAOrC,EAAEsC,SAAF,EAAb;;AACA,UAAGD,QAAQA,KAAKrD,CAAL,KAAW,CAAnB,IAAwBqD,KAAKpD,CAAL,IAAU,CAArC,EAAwC;AACvC;AACA0B,cAAM4B,IAAN,CAAW3B,CAAX,IAAgB,IAAhB,CAFuC,CAGvC;AACA;AACA;AACA;;AACAZ,UAAEmB,IAAF,CAAO,SAAOP,CAAd,EAAiBiB,IAAjB,CAAsBzC,OAAtB;AACA,OARD,MAQO;AACN,cAAM6B,MAAMjB,EAAEoB,IAAF,EAAZ;;AACA,YAAGnC,KAAK,CAAL,IAAUgC,IAAIjC,CAAJ,KAAU,CAApB,IAAyBiC,IAAIjC,CAAJ,KAAU,EAAnC,IAAyC,EAAEiC,IAAIjC,CAAJ,IAAS,CAAT,KAAeiC,IAAIhC,CAAJ,GAAQ,GAAR,IAAegC,IAAIhC,CAAJ,GAAQ,IAAtC,CAAF,CAA5C,EAA4F;AAC3F;AACAe,YAAE6B,IAAF,CAAO/B,KAAP;AACA;;AACDE,UAAEwC,IAAF,CAAOzD,GAAP;AACA;AACD,KAlBD,MAkBO,IAAGE,KAAK,CAAL,IAAU0B,MAAM8B,GAAnB,EAAwB;AAC9BzC,QAAEwC,IAAF,CAAOzD,GAAP;AACA,KAFM,MAEA;AACNiB,QAAEwC,IAAF,CAAOzD,GAAP;AACA;AACD,GAxBD,MAwBO,IAAGC,KAAK,CAAR,EAAW;AACjB;AACA2B,UAAMX,CAAN,CAAQ6B,IAAR,CAAa9C,GAAb,EAAkBuC,KAAlB;AACA,UAAMoB,KAAK9B,IAAI,CAAf;;AACA,QAAGD,MAAM4B,IAAN,CAAWG,EAAX,CAAH,EAAmB;AAClB;AACA/B,YAAM4B,IAAN,CAAWG,EAAX,IAAiB,KAAjB,CAFkB,CAGlB;;AACA1C,QAAEkB,MAAF,CAAS,SAAOwB,EAAhB,EAAoBZ,YAApB,CAAiC3C,WAAjC,EAA8CsC,UAA9C,CAAyD;AAACzC,WAAE,CAAH;AAAKC,WAAE;AAAP,OAAzD,EAAyEqC,KAAzE;AACA;AACD;;;;;;;;;;AAQA,QAAGX,MAAMI,KAAN,CAAYH,CAAZ,CAAH,EAAmB;AAClB;AACA;AACAZ,QAAEmB,IAAF,CAAO,OAAP;AACAT,kBAAYC,KAAZ,EAAkBC,CAAlB;AACAZ,QAAEkB,MAAF,CAAS,OAAT;AACAP,YAAMI,KAAN,CAAYH,CAAZ,IAAiB,IAAjB;AACA;AACD,GA1BM,MA0BA,IAAG5B,KAAK,CAAR,EAAU;AAChB,QAAGC,KAAK,GAAL,IAAYA,KAAK,GAAjB,IAAwBA,KAAK,IAAhC,EAAsC;AACrC,YAAMoD,OAAOrC,EAAEoB,IAAF,EAAb;AACA,YAAMC,OAAOgB,SAASA,KAAKnD,CAAL,IAAUmD,KAAKpD,CAAxB,CAAb;;AACA,YAAM0D,UAAUvC,KAAKA,KAAKH,gBAAO2C,WAAP,CAAmB3C,gBAAO4C,UAAP,CAAkBzC,CAAlB,CAAnB,KAA4CH,gBAAOqC,SAAP,CAAiBlC,CAAjB,CAAtE;;AACA,UAAGiB,SAAU/C,YAAYwE,QAAZ,CAAqBzB,IAArB,KAA8BsB,QAAQN,IAAR,CAA/B,IAAiD9D,aAAauE,QAAb,CAAsBzB,IAAtB,CAAjD,IAAgF7C,MAAMsE,QAAN,CAAezB,IAAf,CAAzF,CAAH,EAAmH;AAClHtC,YAAIG,CAAJ,GAAQb,MAAOY,IAAI,IAAX,CAAR;AACA0B,cAAMX,CAAN,CAAQwB,WAAR,CAAoBnC,YAApB,EAAkCkC,mBAAlC,GAAwDO,YAAxD,CAAqE3C,WAArE,EAAkFsC,UAAlF,CAA6F1C,GAA7F;AACA,eAAO4B,KAAP;AACA,OAJD,MAIO,IAAG0B,KAAKrD,CAAL,IAAU,CAAV,IAAeqD,KAAKpD,CAAL,IAAU,CAA5B,EAA+B;AACrC,cAAM8D,OAAO/C,EAAEgD,QAAF,EAAb;AACA,cAAM3B,OAAO0B,QAAQA,KAAK7D,CAA1B;;AACA,YAAGmC,QAAQ9C,aAAauE,QAAb,CAAsBzB,IAAtB,CAAX,EAAwC;AACvC,cAAGA,QAAQ,UAAX,EAAuB;AACtB;AACAV,kBAAMX,CAAN,CAAQ6B,IAAR,CAAa/B,KAAb,EAAoB0C,IAApB,CAAyBrD,WAAzB,EAAsC0C,IAAtC,CAA2C;AAAC7C,iBAAE,CAAH;AAAKE,iBAAE;AAAP,aAA3C,EAAkE2C,IAAlE,CAAuExC,YAAvE,EAAqFiC,KAArF,GAA6FO,IAA7F,CAAkGxC,YAAlG,EAAgHiC,KAAhH,GACEO,IADF,CACO;AAAC7C,iBAAE,CAAH;AAAKE,iBAAE;AAAP,aADP,EACsBsD,IADtB,CAC2BrD,WAD3B,EACwC0C,IADxC,CAC6C;AAAC7C,iBAAE,CAAH;AAAKE,iBAAE;AAAP,aAD7C,EAC6DsD,IAD7D,CACkErD,WADlE,EAC+E0C,IAD/E,CACoFxC,YADpF,EACkGiC,KADlG,GAEEO,IAFF,CAEOxC,YAFP,EAEqBiC,KAFrB;AAGA;;AACD,iBAAOX,KAAP;AACA;AACD;AACD;;AACD,QAAG1B,KAAK,GAAL,IAAYmD,MAAf,EAAuB;AACtB;AACApC,QAAE4B,GAAF;AACA,YAAMnC,QAAQkB,MAAMlB,KAApB;AACAkB,YAAMlB,KAAN,GAAc,IAAd;;AACA,UAAG2C,UAAU,CAAb,EAAgB;AACfpC,UAAE6B,IAAF,CAAOrC,QAAQC,KAAR,EAAckB,MAAMjB,KAApB,CAAP;AACAiB,cAAM8B,GAAN;AACA9B,cAAMjB,KAAN,GAAc,EAAd;AACA,OAJD,MAIO,IAAG0C,UAAU,CAAV,IAAeA,UAAU,CAA5B,EAA+B;AACrCpC,UAAE6B,IAAF,CAAOhC,SAASJ,KAAT,CAAP,EADqC,CACb;AACxB;;AACDkB,YAAMI,KAAN,CAAYH,CAAZ;AACA,aAAOD,KAAP;AACA,KAdD,MAcO,IAAG1B,KAAK,IAAR,EAAc;AACpB,YAAMoD,OAAOrC,EAAEoB,IAAF,EAAb;;AACA,UAAGiB,KAAKrD,CAAL,IAAU,CAAV,IAAeqD,KAAKpD,CAAL,IAAU,GAA5B,EAAiC;AAChC;AACA,YAAGmD,MAAH,EAAW;AACV,gBAAM3C,QAAQkB,MAAMlB,KAApB;AACAO,YAAE4B,GAAF;AACA5B,YAAE6B,IAAF,CAAOrC,QAAQC,KAAR,EAAckB,MAAMjB,KAApB,CAAP;AACAM,YAAE6B,IAAF,CAAO9C,GAAP;AACA4B,gBAAMjB,KAAN,GAAc,EAAd;AACA;;AACDiB,cAAMyB,MAAN,GAAeA,SAAS,CAAxB;AACA,eAAOzB,KAAP;AACA;AACD,KAdM,MAcA,IAAG1B,KAAK,IAAR,EAAc;AACpB,YAAM8D,OAAO/C,EAAEiD,eAAF,EAAb;;AACA,UAAGF,QAAQA,KAAK/D,CAAL,IAAU,CAAlB,IAAuB+D,KAAK9D,CAAL,IAAU,CAApC,EAAuC;AACtC8D,aAAK9D,CAAL,IAAU,IAAV;AACA;;AACD,YAAMoD,OAAOrC,EAAEoB,IAAF,CAAO,CAAP,CAAb;AACApB,QAAE4B,GAAF;AACA7C,UAAIG,CAAJ,GAAQmD,KAAKpD,CAAb;AACA,KARM,MAQA,IAAGA,KAAK,GAAL,IAAYmD,UAAU,CAAzB,EAA4B;AAClC;AACAzB,YAAMyB,MAAN,GAAeA,SAAS,CAAxB;AACA,aAAOzB,KAAP;AACA;;AACD,QAAG1B,KAAK,GAAL,IAAYA,KAAK,IAApB,EAA0B;AACzB,UAAGZ,MAAM6E,cAAN,CAAqBjE,CAArB,CAAH,EAA4BF,IAAIG,CAAJ,GAAQb,MAAMY,CAAN,CAAR;AAC5Be,QAAE6B,IAAF,CAAO9C,GAAP,EAAYyD,IAAZ,CAAiBrD,WAAjB,EAA8B0C,IAA9B,CAAmCxC,YAAnC,EAAiDiC,KAAjD;AACA,KAHD,MAGO,IAAGrC,KAAK,GAAL,IAAYA,IAAI,IAAnB,EAAyB;AAC/B;AACA,YAAMoD,OAAOrC,EAAEoB,IAAF,EAAb;AACA,YAAM+B,UAAU,CAAClE,KAAK,GAAL,IAAYA,KAAK,GAAlB,MAA2B,CAACoD,IAAD,IAAS,CAACA,KAAKrD,CAAf,IAAoBqD,KAAKrD,CAAL,IAAU,CAA9B,IAAmCqD,KAAKrD,CAAL,IAAU,CAAxE,CAAhB;AACA,YAAMoE,KAAKD,UAAUlE,IAAI,GAAd,GAAoBA,CAA/B;AACAF,UAAIE,CAAJ,GAAQmE,EAAR;AACA,YAAMC,WAAWhF,MAAM6E,cAAN,CAAqBE,EAArB,IAA2B/E,MAAM+E,EAAN,CAA3B,GAAuC,OAAKrE,IAAIG,CAAjE;AACAH,UAAIG,CAAJ,GAAQmE,QAAR;AACArD,QAAE6B,IAAF,CAAO9C,GAAP;AACA,UAAG,CAAC4B,MAAMI,KAAN,CAAYH,CAAZ,CAAJ,EAAoBD,MAAMI,KAAN,CAAYH,CAAZ,IAAiB,CAAjB;AACpBZ,QAAEmB,IAAF,CAAOP,IAAE,GAAF,GAAMD,MAAMI,KAAN,CAAYH,CAAZ,GAAb;AACA,KAXM,MAWA;AACNZ,QAAE6B,IAAF,CAAO9C,GAAP;AACA;AACD,GAjFM,MAiFA,IAAGC,KAAK,CAAR,EAAW;AACjB,QAAG,MAAMqC,IAAN,CAAWpC,CAAX,CAAH,EAAkB;AACjB;AACAF,UAAIE,CAAJ,GAAQA,EAAEqE,OAAF,CAAU,KAAV,EAAgB,EAAhB,CAAR;AACA,UAAG,QAAQjC,IAAR,CAAatC,IAAIE,CAAjB,CAAH,EAAwBF,IAAIC,CAAJ,GAAQ,CAAR;AACxBgB,QAAE6B,IAAF,CAAO;AAAC7C,WAAE,EAAH;AAAMC,WAAE,GAAR;AAAYC,WAAE;AAAd,OAAP,EAA2BsD,IAA3B,CAAgCrD,WAAhC,EAA6C0C,IAA7C,CAAkD9C,GAAlD,EAAuD8C,IAAvD,CAA4DxC,YAA5D,EAA0EiC,KAA1E;AACA,KALD,MAKO;AACN,YAAMe,OAAOrC,EAAEoB,IAAF,EAAb;;AACA,UAAGiB,KAAKrD,CAAL,IAAU,CAAV,IAAeqD,KAAKpD,CAAL,IAAU,GAAzB,IAAgC,CAACkD,EAApC,EAAwC;AACvCxB,cAAMlB,KAAN,GAAcR,CAAd;AACA0B,cAAMyB,MAAN,GAAeA,SAAS,CAAxB;AACA,eAAOzB,KAAP;AACA,OAJD,MAIO,IAAGyB,UAAU,CAAb,EAAgB;AACtBzB,cAAMyB,MAAN,GAAeA,SAAS,CAAxB;AACA,YAAG,CAACzB,MAAMjB,KAAV,EAAiBiB,MAAMjB,KAAN,GAAc,EAAd;AACjBiB,cAAMjB,KAAN,CAAYmC,IAAZ,CAAiB,CAAC5C,CAAD,CAAjB;AACA,OAJM,MAIA;AACNe,UAAE6B,IAAF,CAAO9C,GAAP;AACA;AACD;AACD,GApBM,MAoBA,IAAGC,MAAM,CAAT,EAAY;AAClBgB,MAAE6B,IAAF,CAAO9C,GAAP;;AACA,QAAG4B,MAAMI,KAAN,CAAYH,CAAZ,CAAH,EAAmB;AAClB;AACAZ,QAAEmB,IAAF,CAAO,KAAP;AACAT,kBAAYC,KAAZ,EAAkBC,CAAlB;AACAZ,QAAEkB,MAAF,CAAS,KAAT;AACAP,YAAMI,KAAN,CAAYH,CAAZ,IAAiB,IAAjB;AACA;AACD,GATM,MASA,IAAG5B,MAAM,EAAT,EAAY;AAClB;AACA2B,UAAMwB,EAAN,GAAW,IAAX;AACA,QAAGC,MAAH,EAAWzB,MAAMyB,MAAN,GAAe,CAAf;AACX,GAJM,MAIA;AACN,QAAGA,UAAU,CAAb,EAAgB;AACfzB,YAAMjB,KAAN,CAAY6D,QAAZ,CAAqB1B,IAArB,CAA0B5C,CAA1B;AACA0B,YAAMyB,MAAN,GAAe,CAAf;AACA,KAHD,MAGO;AACNpC,QAAE6B,IAAF,CAAO9C,GAAP;AACA;AACD;;AACD4B,QAAMuB,KAAN,GAAcnD,IAAI6B,CAAlB;AACA,SAAOD,KAAP;AACA;;AAED,SAAS6C,WAAT,CAAqB7C,KAArB,EAA2B8C,IAA3B,EAAiC;AAChC,QAAMC,OAAO/C,MAAM+C,IAAnB;;AACA,MAAGA,SAASC,SAAZ,EAAuB;AACtBhD,UAAMiD,IAAN,GAAa,KAAK,CAAlB;AACAjD,UAAM+C,IAAN,GAAaD,IAAb;AACA,WAAO9C,KAAP;AACA;;AACD,MAAG+C,QAAQ9E,GAAX,EAAgB;AACf+B,UAAMiD,IAAN,GAAajD,MAAMiD,IAAN,IAAcjD,MAAM5B,GAAN,CAAUC,CAAV,IAAe,CAA7B,GAAiC,KAAK,CAAtC,GAA0C;AAACA,SAAE,CAAH;AAAMC,SAAE,CAAR;AAAWC,SAAEN;AAAb,KAAvD;AACA,WAAO+B,KAAP;AACA;;AACD,QAAMkD,UAAUlD,MAAMmD,IAAtB;AACA,QAAMC,aAAapD,MAAMqD,OAAzB;AACA,QAAMC,SAAStD,MAAMsD,MAArB;AACA,QAAMC,YAAYvD,MAAMwD,MAAxB,CAdgC,CAehC;;AACA,QAAMC,OAAOL,cAAcpD,MAAMlB,KAApB,IAA6BkB,MAAM0D,MAAnC,GAA4C,KAA5C,GAAoDH,cAAc,CAA/E;AACA,QAAMI,IAAIL,SAASP,IAAnB;AACA,QAAMa,MAAMH,OAAO,gBAAKzD,MAAM6D,IAAX,EAAgBd,IAAhB,EAAqBY,CAArB,EAAuB3D,MAAM8D,IAA7B,CAAP,GAA4C,CAAC,EAAD,EAAI,EAAJ,CAAxD;AACA,QAAMD,OAAOD,IAAI,CAAJ,CAAb;AACA,QAAME,OAAOF,IAAI,CAAJ,CAAb;AACA,MAAIG,QAAQ,CAAZ;;AACA,MAAG,CAACF,IAAJ,EAAU;AACTE,YAAQ,CAAR;AACA,GAFD,MAEO,IAAGC,MAAMC,OAAN,CAAcJ,IAAd,CAAH,EAAwB;AAC9BE,YAAQ,CAACF,KAAKK,MAAN,GAAe,CAAf,GAAmBL,KAAK,CAAL,EAAQM,EAAR,KAAeR,CAAf,GAAmB,CAAnB,GAAuB,CAAlD;AACA,GAFM,MAEA,IAAG,QAAQE,IAAX,EAAiB;AACvBE,YAAQF,KAAKM,EAAL,KAAYR,CAAZ,GAAgB,CAAhB,GAAqBG,KAAKI,MAAL,GAAc,CAAd,IAAmBJ,KAAK,CAAL,EAAQK,EAAR,KAAeR,CAAnC,GAAwC,CAAxC,GAA4C,CAAxE;AACA;;AACD,MAAGI,UAAU,CAAb,EAAgB;AACf,UAAMH,MAAM,gBAAKC,IAAL,EAAUf,IAAV,EAAea,IAAIb,IAAnB,EAAwB,CAAC,GAAGgB,IAAJ,CAAxB,CAAZ;AACA,UAAMM,QAAQR,IAAI,CAAJ,CAAd;;AACA,QAAGQ,UAAWJ,MAAMC,OAAN,CAAcG,KAAd,KAAwBA,MAAMF,MAAN,GAAe,CAAxC,IAA8C,QAAQE,KAAhE,CAAH,EAA2E;AAC1E;AACAL,cAAQ,CAAR;AACA,KAHD,MAGO,IAAGA,SAAS,CAAZ,EAAe;AACrB;AACA,UAAGF,KAAK,CAAL,EAAQQ,EAAR,GAAa,CAAb,IAAkBtG,SAAS2C,IAAT,CAAcqC,IAAd,CAAlB,IAAyChF,SAAS2C,IAAT,CAAcoC,IAAd,CAA5C,EAAiE;AAChEiB,gBAAQ,CAAR;AACA,OAJoB,CAKrB;;AACA,KANM,MAMA,IAAGA,UAAU,CAAb,EAAgB;AACtB;AACAA,cAAQ,CAAR;AACA;AACD,GA7C+B,CA8ChC;;;AACA,MAAGjB,QAAQ,GAAR,IAAeiB,SAAS,CAAxB,IAA6BhG,SAAS2C,IAAT,CAAcqC,IAAd,CAAhC,EAAqD;AACpDgB,YAAQ,CAAR;AACA;;AACD,MAAIZ,IAAJ,CAlDgC,CAmDhC;;AACA,MAAGY,SAAS,CAAZ,EAAe;AACdZ,WAAOU,KAAKQ,EAAZ;AACA,GAFD,MAEO,IAAGN,SAAS,CAAZ,EAAe;AACrBZ,WAAOU,KAAK,CAAL,EAAQQ,EAAf;AACA,GAFM,MAEA,IAAGN,SAAS,CAAZ,EAAe;AACrBZ,WAAOW,KAAK,CAAL,EAAQO,EAAf;AACA,GAFM,MAEA,IAAG,KAAK3D,IAAL,CAAUqC,IAAV,CAAH,EAAoB;AAC1BI,WAAO,EAAP;AACA,GAFM,MAEA,IAAG,QAAQzC,IAAR,CAAaqC,IAAb,CAAH,EAAuB;AAC7BI,WAAO,EAAP;AACA,GAFM,MAEA,IAAG,WAAWzC,IAAX,CAAgBqC,IAAhB,CAAH,EAA0B;AAChCI,WAAO,EAAP;AACA,GAFM,MAEA;AACNA,WAAO,CAAP;AACA;;AACD,QAAMmB,QAASnB,QAAQ,CAAR,IAAaL,QAAQ,GAApC;;AACA,MAAGwB,KAAH,EAAU;AACTP,YAAQZ,OAAO,CAAf;AACA;;AACD,MAAIO,SAAUD,SAASN,QAAQ,EAAR,IAAeA,QAAQ,CAAR,IAAaD,WAAW,CAAxB,IAA6B,QAAQxC,IAAR,CAAaoC,IAAb,CAArD,CAAD,IAAgF9C,MAAM0D,MAAN,KAAiBP,SAAS,CAAT,IAAcA,QAAQ,EAAvC,CAA7F;AACA,MAAIrE,QAAS2E,QAAQ,CAACC,MAAT,IAAmBP,QAAQ,EAA3B,IAAiCY,SAAS,CAA3C,IAAkD/D,MAAMlB,KAAN,IAAeqE,QAAQ,EAAzE,IAAgFmB,KAA5F;AACA,MAAIC,OAAQzF,SAAS,mBAAmB4B,IAAnB,CAAwBoC,IAAxB,CAAV,IAA6CY,UAAU,UAAUhD,IAAV,CAAeoC,IAAf,CAAlE;AACA,MAAI0B,IAAJ;;AACA,MAAGd,UAAU5E,KAAb,EAAoB;AACnB0F,WAAO,CAAP;AACA,GAFD,MAEO,IAAGf,IAAH,EAAS;AACf,QAAGN,QAAQ,CAAR,IAAaA,QAAQ,CAAxB,EAA2B;AAC1BqB,aAAO,CAAP,CAD0B,CAChB;AACV,KAFD,MAEO,IAAGrB,QAAQ,IAAX,EAAiB;AACvBqB,aAAO,CAAP,CADuB,CACb;AACV;AACA;AACA;AACA;AACA,KANM,MAMA;AACNA,aAAO,CAAP;AACA;AACD,GAZM,MAYA;AACN;AACA,QAAIjB,aAAa,CAAb,IAAkBR,QAAQ,IAA1B,IAAkCD,SAAS,IAA5C,IAAsDS,aAAa,CAAb,IAAkBR,QAAQ,GAAnF,EAAyF;AACxFyB,aAAO,CAAP,CADwF,CAC9E;AACV,KAFD,MAEO,IAAGpB,cAAcL,QAAQ,GAAtB,IAA6BD,QAAQ,GAAxC,EAA6C;AACnD0B,aAAO,CAAP,CADmD,CACzC;AACV;AACA;AACA;AACA;AACA,KANM,MAMA;AACNA,aAAO,CAAP;AACA;AACD;;AACD,MAAIpG,GAAJ;;AACA,MAAG,CAACoG,IAAJ,EAAU;AACT,QAAGD,QAAQpB,QAAQ,CAAnB,EAAsB;AACrB/E,YAAM;AAACC,WAAEqF,SAAS,CAAT,GAAa,CAAhB;AAAkBpF,WAAEqF;AAApB,OAAN;AACA,KAFD,MAEO,IAAGD,UAAUP,QAAQ,CAArB,EAAwB,CAC9B;AACA,KAFM,MAEA,IAAGA,QAAQ,EAAR,IAAcnD,MAAMmD,IAAN,KAAe,EAAhC,EAAoC;AAC1C/E,YAAM;AAACC,WAAE;AAAH,OAAN;AACA,KAFM,MAEA,IAAG0F,SAAS,CAAT,IAAcA,UAAU,CAA3B,EAA8B;AACpC,UAAI1F,IAAI8E,QAAQ,CAAR,IAAaA,QAAQ,CAArB,IAA0BA,QAAQ,IAAlC,GAAyC,CAAzC,GACPA,QAAQ,CAAR,IAAaA,QAAQ,CAArB,IAA0BA,QAAQ,IAAlC,GAAyC,CAAzC,GACCA,QAAQ,GAAR,GAAc,CAAd,GACCA,QAAQ,CAAR,GAAY,CAAZ,GACCA,QAAQ,CAAR,GAAY,EAAZ,GACCA,QAAQ,CAAR,GAAY,EAAZ,GACC,CANN;AAOA/E,YAAM;AAACC,WAAEA,CAAH;AAAKC,WAAE6E,IAAP;AAAY5E,WAAEoF;AAAd,OAAN;AACA;AACD,GAjBD,MAiBO,IAAGa,QAAQ,CAAR,IAAaA,QAAQ,CAAxB,EAA2B;AACjCpG,UAAM;AAACC,SAAEmG,QAAQ,CAAR,GAAY,CAAZ,GAAgB,CAAnB;AAAqBlG,SAAEgF;AAAvB,KAAN;AACA,GA3H+B,CA4HhC;AACA;AACA;AACA;;;AACA,MAAIG,QAAQN,QAAQ,EAAhB,IAAsBG,UAAU,EAAjC,IAAwClF,GAAxC,IAA+CoG,IAAlD,EAAwD;AACvDxE,UAAMsD,MAAN,GAAe,EAAf;AACA,GAFD,MAEO;AACNtD,UAAMsD,MAAN,GAAeK,CAAf;AACA;;AACD,MAAG7E,KAAH,EAAUkB,MAAMyE,SAAN,GAAkBrG,GAAlB,CArIsB,CAsIhC;;AACA4B,QAAM+C,IAAN,GAAayB,QAAQ,CAAR,GAAY,KAAK,CAAjB,GAAqB1B,IAAlC;AACA9C,QAAM0D,MAAN,GAAeA,UAAU,CAACa,IAA1B;AACAvE,QAAMlB,KAAN,GAAcA,SAAS,CAACyF,IAAxB;AACAvE,QAAMmD,IAAN,GAAaA,IAAb;;AACA,MAAG/E,GAAH,EAAQ;AACPA,QAAIsG,IAAJ,GAAW1E,MAAM0E,IAAjB;AACAtG,QAAIuG,MAAJ,GAAa3E,MAAM2E,MAAnB;AACA3E,UAAM5B,GAAN,GAAYA,GAAZ;AACA;;AACD4B,QAAMiD,IAAN,GAAa7E,GAAb;AACA,MAAIwG,UAAU,KAAd;AACA,MAAG7B,QAAQ,IAAX,EAAiB6B,UAAU,IAAV;;AACjB,MAAGA,OAAH,EAAY;AACX5E,UAAM0E,IAAN;AACA1E,UAAM2E,MAAN,GAAe,CAAf;AACA,GAHD,MAGO;AACN3E,UAAM2E,MAAN;AACA;;AAED3E,QAAM6D,IAAN,GAAaE,QAAQ,CAAR,GAAYvG,GAAZ,GAAkBqG,IAA/B;AACA7D,QAAM8D,IAAN,GAAaC,QAAQ,CAAR,GAAY,EAAZ,GAAiBD,IAA9B;;AACA,MAAGU,QAAQ,CAAX,EAAc;AACbxE,UAAMwD,MAAN,GAAeL,IAAf;AACA,GAFD,MAEO,IAAGqB,QAAQ,CAAX,EAAc;AACpBxE,UAAMwD,MAAN,GAAe,CAAf;AACA,GAFM,MAEA,IAAGgB,QAAQ,CAAX,EAAc;AACpBxE,UAAMqD,OAAN,GAAgB,IAAhB;AACA,GAFM,MAEA,IAAGmB,QAAQ,CAAX,EAAc;AACpBxE,UAAMqD,OAAN,GAAgB,KAAhB;AACA;;AACD,SAAOrD,KAAP;AACA;;AAED,SAAS6E,KAAT,CAAeC,EAAf,EAAkBC,KAAlB,EAAyB;AACxB,QAAM;AAAE1G,KAAF;AAAKC,KAAL;AAAQC;AAAR,MAAcwG,KAApB;;AACA,MAAG1G,MAAM,CAAT,EAAY;AACXyG,OAAGhC,IAAH,CAAQvE,MAAMN,GAAN,GAAY,EAAZ,GAAiB,OAAzB;AACA,GAFD,MAEO,IAAGI,KAAK,CAAR,EAAW;AACjByG,OAAGhC,IAAH,CAAS,IAAGxE,CAAE,GAAd;AACA,GAFM,MAEA,IAAGD,KAAK,CAAL,IAAUA,KAAK,CAAlB,EAAqB;AAC3ByG,OAAGhC,IAAH,CAAQxE,CAAR;AACA,GAFM,MAEA,IAAGD,KAAK,CAAR,EAAW;AACjByG,OAAGhC,IAAH,CAAQ,OAAKxE,CAAL,GAAO,IAAf;AACA,GAFM,MAEA,IAAGD,KAAK,EAAR,EAAY;AAClB,QAAI2G,IAAI,MAAI1G,CAAZ;;AACA,SAAI,IAAI,CAAC2G,CAAD,EAAG3G,CAAH,CAAR,IAAiByG,MAAM9F,CAAvB,EAA0B;AACzB+F,WAAK,MAAIC,CAAJ,GAAM,KAAN,GAAY3G,CAAZ,GAAc,IAAnB;AACA;;AACD0G,SAAK,GAAL,CALkB,CAMlB;;AACAF,OAAGhC,IAAH,CAAQkC,CAAR;AACA,GARM,MAQA,IAAG3G,KAAK,EAAR,EAAY;AAClByG,OAAGhC,IAAH,CAAQ,OAAKxE,CAAL,GAAO,GAAf;AACA,GAFM,MAEA,IAAGD,KAAK,CAAL,IAAUC,KAAK,IAAlB,EAAwB;AAC9BwG,OAAGhC,IAAH,CAAQ,OAAKvE,CAAL,GAAO,KAAf;AACA,GAFM,MAEA,IAAGA,CAAH,EAAK;AACXuG,OAAGhC,IAAH,CAAQvE,CAAR;AACA;;AACD,SAAOuG,EAAP;AACA;;AAGD,SAASI,IAAT,CAAcC,GAAd,EAAkBJ,KAAlB,EAAwBjC,IAAxB,EAA6B;AAC5B,MAAIsC,KAAKL,MAAM1G,CAAf;AACA,MAAIgH,KAAKN,MAAMzG,CAAf;AACA,MAAIe,IAAI,EAAR;;AACA,MAAG+F,MAAM,CAAT,EAAY;AACX,QAAGC,MAAM,CAAT,EAAY;AACXhG,UAAI,CAAC,EAAD,CAAJ;AACA,KAFD,MAEO,IAAGgG,MAAM,IAAT,EAAe;AACrBhG,UAAI,CAAC,CAAD,CAAJ;AACA,KAFM,MAEA,IAAGgG,MAAM,IAAT,EAAe;AACrBhG,UAAI,CAAC,CAAD,CAAJ;AACA;AACD,GARD,MAQO,IAAG+F,MAAM,CAAT,EAAY;AAClB/F,QAAI,CAAC,EAAD,CAAJ;AACA,GAFM,MAEA,IAAG+F,MAAM,CAAT,EAAY;AAClB/F,QAAI,CAAC,CAAD,EAAGgG,EAAH,CAAJ;AACA,GAFM,MAEA,IAAGD,MAAM,CAAT,EAAY;AAClB,QAAG,MAAM1E,IAAN,CAAW2E,EAAX,CAAH,EAAmBA,KAAK,MAAMA,EAAX;AACnBhG,QAAI,CAAC,EAAD,EAAIgG,EAAJ,CAAJ;AACA,GAHM,MAGA,IAAGD,MAAM,CAAT,EAAY;AAClB,QAAG,UAAU1E,IAAV,CAAe2E,EAAf,CAAH,EAAuB;AACtBhG,UAAI,CAAC,CAAD,EAAGgG,KAAG,EAAN,CAAJ;AACA,KAFD,MAEO;AACNhG,UAAIyD,QAAQA,KAAKzE,CAAL,IAAU,CAAlB,IAAuByE,KAAKxE,CAAL,IAAU,CAAjC,GAAqC,CAAC,EAAD,EAAI+G,EAAJ,CAArC,GAA+C,CAAC,CAAD,EAAGA,EAAH,CAAnD;AACA;AACD,GANM,MAMA,IAAGD,MAAM,CAAN,IAAWA,MAAM,EAApB,EAAwB;AAC9B,QAAGC,MAAM,IAAT,EAAe;AACdhG,UAAI,CAAC,CAAD,EAAG0F,MAAMxG,CAAT,CAAJ;AACA,KAFD,MAEO;AACNc,UAAI,CAAC,EAAD,EAAI0F,MAAMxG,CAAV,CAAJ;AACA;AACD,GANM,MAMA,IAAG6G,MAAM,CAAT,EAAY;AAClB/F,QAAI,CAAC,CAAD,EAAGgG,EAAH,CAAJ;AACA,GAFM,MAEA,IAAGD,MAAM,CAAT,EAAY;AAClB/F,QAAI,CAAC,CAAD,EAAGgG,EAAH,CAAJ;AACA,GAFM,MAEA,IAAGD,MAAM,EAAT,EAAa;AACnB/F,QAAI,CAAC,CAAD,EAAGgG,EAAH,CAAJ;;AACA,SAAI,IAAI,CAACJ,CAAD,EAAG3G,CAAH,CAAR,IAAiByG,MAAM9F,CAAvB,EAA0B;AACzBI,UAAIA,EAAEiG,MAAF,CAAS,CAAC,CAAD,EAAGL,CAAH,EAAK,CAAL,EAAO3G,CAAP,CAAT,CAAJ;AACA;AACD,GALM,MAKA,IAAG8G,MAAM,EAAT,EAAa;AACnB/F,QAAI,CAAC,EAAD,CAAJ;AACA,GAFM,MAEA,IAAG+F,MAAM,EAAT,EAAa;AACnB/F,QAAI,CAAC,EAAD,EAAI,IAAJ,EAAS,EAAT,CAAJ;AACA,GA5C2B,CA6C5B;;;AACA,OAAI,IAAIJ,CAAR,IAAaI,CAAb,EAAgB8F,IAAIrC,IAAJ,CAAS7D,CAAT;;AAChB,SAAOkG,GAAP;AACA;;AAEM,MAAMI,WAAWvF,SAASwF,UAAU;AAC1C,SAAOC,iBAAWC,MAAX,CAAkBZ,MAAM;AAC9BU,WAAOG,SAAP,CAAiB;AAChB7C,WAAKxC,GAAL,EAAU;AACTuC,oBAAY7C,KAAZ,EAAkBM,GAAlB;;AACA,YAAGN,MAAMiD,IAAT,EAAe;AACd;AACA6B,aAAGhC,IAAH,CAAQ9C,MAAMiD,IAAd;AACA;AACD,OAPe;;AAQhB2C,iBAAW;AACV/C,oBAAY7C,KAAZ,EAAkB/B,GAAlB;AACA,YAAG+B,MAAMiD,IAAT,EAAe6B,GAAGhC,IAAH,CAAQ9C,MAAMiD,IAAd;AACfJ,oBAAY7C,KAAZ;AACA,YAAGA,MAAMiD,IAAT,EAAe6B,GAAGhC,IAAH,CAAQ9C,MAAMiD,IAAd;AACf6B,WAAGc,QAAH;AACA;;AAde,KAAjB;AAgBA,GAjBM,CAAP,CAD0C,CAmB1C;AACA,CApBM;;;;AAsBP,MAAMC,iBAAiB,MAAM;AAC5B,SAAO;AACN5C,UAAK,KADC;AAEN1B,WAAM,CAFA;AAGNlC,OAAE,IAAIC,eAAJ,EAHI;AAINsC,UAAK,EAJC;AAKNxB,WAAM,EALA;AAMN0B,SAAI,CANE;AAONN,QAAG,KAPG;AAQNC,YAAO,CARD;AASN3C,WAAM;AATA,GAAP;AAWA,CAZD;;AAcO,MAAMgH,MAAMC,SAASC,SAAS;AACpC,QAAMC,MAAMF,MAAME,GAAlB;AACA,QAAMC,MAAMH,MAAMG,GAAlB;AACA,MAAIlG,QAAQ6F,gBAAZ;AACA,SAAOJ,iBAAWC,MAAX,CAAkBZ,MAAM;AAC9BkB,UAAML,SAAN,CAAgB;AACf7C,WAAK1E,GAAL,EAAS;AACR,cAAMiB,IAAIW,MAAMX,CAAhB;AACA,YAAIkC,QAAQvB,MAAMuB,KAAlB;;AACA,YAAGnD,IAAIC,CAAJ,IAAS,CAAZ,EAAe;AACdkD;;AACA,cAAGA,QAAQ,CAAX,EAAc;AACb,kBAAM,IAAI4E,KAAJ,CAAU,0BAAV,CAAN;AACA;;AACD,cAAG,CAACnG,MAAM5B,GAAP,IAAc4B,MAAM5B,GAAN,CAAUC,CAAV,IAAe,CAAhC,EAAmC,MAAM,IAAI8H,KAAJ,CAAU,6BAAV,CAAN;AACnC,SAND,MAMO,IAAG/H,IAAIC,CAAJ,IAAS,CAAZ,EAAe;AACrB;AACAkD;AACA;;AACDnD,YAAI6B,CAAJ,GAAQsB,KAAR,CAbQ,CAcR;;AACAvB,gBAAQsB,QAAQlD,GAAR,EAAY4B,KAAZ,CAAR;AACAA,cAAM5B,GAAN,GAAYA,GAAZ,CAhBQ,CAiBR;;AACA,YAAGA,IAAIC,CAAJ,KAAU,CAAb,EAAgB;AACf,cAAGkD,UAAU,CAAb,EAAe;AACd;AACA,kBAAM,IAAI4E,KAAJ,CAAU,wBAAV,CAAN;AACA,WAJc,CAKf;;;AACA9G,YAAE+G,QAAF,GAAanF,GAAb;;AACA,cAAGiF,GAAH,EAAQ;AACP,mBAAO,0BAAO7G,EAAEE,QAAF,CAAW,IAAX,CAAP,EAAwB,CAACN,CAAD,EAAGQ,CAAH,KAAS;AACvCR,gBAAE6D,IAAF,CAAOrD,CAAP;AACA,qBAAOR,CAAP;AACA,aAHM,EAGL6F,EAHK,CAAP;AAIA,WALD,MAKO,IAAGmB,GAAH,EAAQ;AACd,2CAAY5G,EAAEE,QAAF,EAAZ,EAAyBsF,KAAzB,EAA+BC,EAA/B;AACA,WAFM,MAEA;AACN,2CAAYzF,EAAEE,QAAF,EAAZ,EAAyB2F,IAAzB,EAA8BJ,EAA9B;AACA;;AACD9E,gBAAMX,CAAN,GAAU,IAAIC,eAAJ,EAAV;AACA;AACD,OAtCc;;AAuCfsG,iBAAU;AACTd,WAAGc,QAAH;AACA;;AAzCc,KAAhB;AA0CA,GA3CM,CAAP;AA4CA,CAhDM;;;;AAkDA,MAAMS,iBAAiB,MAAM;AACnC,SAAO;AACNlD,UAAK,CADC;AAENG,YAAO,EAFD;AAGNE,YAAO,CAHD;AAINgB,UAAK,CAJC;AAKNX,UAAKrG,GALC;AAMNkG,YAAO,KAND;AAONL,aAAQ,KAPF;AAQNvE,WAAO,KARD;AASN4F,UAAM,CATA;AAUNC,YAAQ,CAVF;AAWNb,UAAM,EAXA;AAYN1F,SAAK,EAZC;AAaN6E,UAAK,KAAK;AAbJ,GAAP;AAeA,CAhBM;;;;AAkBA,MAAMqD,QAAQ,CAACxC,IAAD,EAAMiC,QAAQ,EAAd,KAAqB,gCAAejC,IAAf,EAAqByC,IAArB,CAA0B,yBAASC,SAAS,gBAAKA,MAAMC,QAAN,EAAL,CAAlB,CAA1B,EAAoElB,SAASc,gBAAT,CAApE,EAA+FP,IAAIC,KAAJ,CAA/F,CAAnC;;;;AAEA,MAAMW,cAAc,CAACC,GAAD,EAAKZ,QAAQ,EAAb,KAAoB,gBAAKY,GAAL,EAAUJ,IAAV,CAAehB,SAASc,gBAAT,CAAf,EAA0CP,IAAIC,KAAJ,CAA1C,CAAxC","sourcesContent":["import { Observable, from } from \"rxjs\";\r\nimport { mergeMap } from \"rxjs/operators\";\r\nimport { find } from \"./trie\";\r\nimport { reduce, reduceAhead } from \"./rich-reducers\";\r\nimport { fromReadStream } from \"./node-stream\";\r\nimport Triply from \"triply\";\r\n\r\nconst ops = require(\"../operator-trie.json\");\r\n\r\nconst opMap = {\r\n\t119: \"rest-params\",\r\n\t505: \"ggt\",\r\n\t507: \"glt\",\r\n\t509: \"geq\",\r\n\t801: \"subtract\",\r\n\t802: \"add\",\r\n\t903: \"divide\",\r\n\t904: \"multiply\",\r\n\t1701: \"minus\",\r\n\t1702: \"plus\",\r\n\t5005: \"maybe\",\r\n\t3904: \"any\",\r\n\t3802: \"many\",\r\n\t2005: \"$_\",\r\n\t1500: \"cast-as\"\r\n};\r\n\r\nconst simpleTypes = [\r\n\t\"item\",\r\n\t\"atomic\",\r\n\t\"string\",\r\n\t\"numeric\",\r\n\t\"integer\",\r\n\t\"number\",\r\n\t\"double\",\r\n\t\"decimal\",\r\n\t\"float\"\r\n];\r\n\r\nconst complexTypes = [\r\n\t\"function\",\r\n\t\"array\",\r\n\t\"map\"\r\n];\r\n\r\nconst kinds = [\r\n\t\"document-node\",\r\n\t\"element\",\r\n\t\"attribute\",\r\n\t\"processing-instruction\",\r\n\t\"comment\",\r\n\t\"text\",\r\n\t\"node\"\r\n];\r\n\r\nconst andOrRe = /^(n:)?(and|or)$/;\r\n\r\nconst ncnameRe = new RegExp(\"[\\\\p{L}\\\\p{N}_-]\",\"u\");\r\n\r\nconst EOF = String.fromCharCode(25);\r\n\r\nconst tpl = (t,v,o) => { return {t:t,v:v,o:o}; };\r\n\r\nconst openParen = () => tpl(1,1,\"(\");\r\n\r\nconst comma = () => tpl(3,100,\",\");\r\n\r\nconst closeParen = () => tpl(2,2,\")\");\r\n\r\nconst openCurly = () => tpl(1,3,\"{\");\r\n\r\nconst closeCurly = () => tpl(2,4,\"}\");\r\n\r\nconst openTag = (qname,attrs) => {\r\n\tconst n = tpl(11,qname);\r\n\tn.a = attrs;\r\n\treturn n;\r\n};\r\n\r\nconst closeTag = qname => tpl(12,qname);\r\n\r\nconst seq = () => tpl(6,\"\");\r\n\r\n\r\nconst log = r => reduce(Triply.traverse(r._root),(a,x) => {\r\n\tconst n = Triply.view(x.$0 == 3 ? x.$3 : x,1);\r\n\tn.is = x.$0 === 1 ? \"LEAF\" : x.$0 === 3 ? \"CLOSE\" : \"BRANCH\";\r\n\tconsole.log(n);\r\n\treturn a;\r\n});\r\n\r\n/*\r\nconst incr = a => a.map(x => {\r\n\tx.d++;\r\n\treturn x;\r\n});\r\n           (x)\r\n    $  --- /$ - , 2 - ) on close, nest:\r\n   /                      \\       mark call again\r\ncall                       /call - , 3 ) on close, nest\r\n*/\r\nfunction handleInfix(state,d) {\r\n\tconst r = state.r;\r\n\tlet lastv;\r\n\tfor(let i = state.infix[d] - 1; i >= 0; i--) {\r\n\t\t// handle each mark\r\n\t\t// mark again so we can peek\r\n\t\tconst bm = d+\":\"+i;\r\n\t\tconst cur = r.unmark(bm).mark(bm).peek();\r\n\t\t// treat and/or\r\n\t\tif(andOrRe.test(cur.o)) {\r\n\t\t\t// wrap the first arg\r\n\t\t\tconst close = r.movePreviousSibling().insertAfter(closeCurly()).peek();\r\n\t\t\tr.movePreviousSibling().openBefore(openCurly(),close);\r\n\t\t\tr.unmark(bm).mark(bm);\r\n\t\t\t// wrap the snd arg\r\n\t\t\tconst close2 = r.moveNextSibling().insertAfter(closeCurly()).peek();\r\n\t\t\tr.movePreviousSibling().openBefore(openCurly(),close2);\r\n\t\t\tr.unmark(bm).mark(bm);\r\n\t\t}\r\n\t\t// normal case: last preceeds\r\n\t\tif(!lastv || lastv > cur.v) {\r\n\t\t\t// move to 2nd arg, insert closing paren, peek\r\n\t\t\tr.pop();\r\n\t\t\tif(cur.v > 900) {\r\n\t\t\t\tconst close = r.moveNextSibling().push(closeParen()).peek();\r\n\t\t\t\tr.movePreviousSibling().insertBefore(openParen());\r\n\t\t\t\tr.openBefore(cur,close);\r\n\t\t\t\tr.unmark(bm);\r\n\t\t\t} else {\r\n\t\t\t\tr.push(comma());\r\n\t\t\t\tconst close = r.moveNextSibling().push(closeParen()).peek();\r\n\t\t\t\tr.unmark(bm);\r\n\t\t\t\tr.movePreviousSibling().insertBefore(openParen());\r\n\t\t\t\tr.openBefore(cur,close);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// remove the operator\r\n\t\t\tr.pop();\r\n\t\t\t// move to the second arg\r\n\t\t\tr.moveNextSibling();\r\n\t\t\t// remove the second argument of this operator\r\n\t\t\tconst arg2 = r.pop();\r\n\t\t\t// move to the previous operator that's already processed\r\n\t\t\t// go into the second argument and wrap it\r\n\t\t\t// move to before the closing paren\r\n\t\t\t//r.unmark(\"OP\");\r\n\t\t\tif(cur.v > 900) {\r\n\t\t\t\tconst close = r.moveNextSibling().push(closeParen()).peek();\r\n\t\t\t\tr.movePreviousSibling().insertBefore(openParen());\r\n\t\t\t\tr.openBefore(cur,close);\r\n\t\t\t} else {\r\n\t\t\t\tr.movePreviousSibling().moveLastChild().movePreviousSibling();\r\n\t\t\t\tconst close = r.push(comma()).push(arg2).push(closeParen()).peek();\r\n\t\t\t\tr.movePreviousSibling().movePreviousSibling().movePreviousSibling();\r\n\t\t\t\tr.insertBefore(openParen()).openBefore(cur,close);//.moveLastChild();\r\n\t\t\t\t// insert open parent, open and add the operator\r\n\t\t\t\t// add comma, the second arg and closing paren\r\n\t\t\t}\r\n\t\t\tr.unmark(bm);\r\n\t\t}\r\n\t\tlastv = cur.v;\r\n\t\t//Object.assign(cur,comma());\r\n\t}\r\n\r\n}\r\n\r\n// NOTE whitespace is ignored by the lexer, but it is in the state\r\nfunction process(tpl,state) {\r\n\tconst t = tpl.t, v = tpl.v, r = state.r;\r\n\tconst d = state.depth;\r\n\t// reset WS every time\r\n\tconst ws = state.ws;\r\n\tconst hasTag = state.hasTag;\r\n\t//console.log(t,v,ws,hasTag);\r\n\tstate.ws = false;\r\n\tstate.hasTag = 0;\r\n\t//console.log(t,v,tpl.o);\r\n\tif(t == 1) {\r\n\t\tif(v == 1) {\r\n\t\t\tconst last = r.lastChild();\r\n\t\t\tif(last && last.t === 2 && last.v == 2) {\r\n\t\t\t\t// 1. mark call\r\n\t\t\t\tstate.call[d] = true;\r\n\t\t\t\t//console.log(\"opencall\",d,_strip(r.peek()));\r\n\t\t\t\t// nest entire tree\r\n\t\t\t\t// 2. push comma\r\n\t\t\t\t// TODO add original position to comma\r\n\t\t\t\tr.mark(\"call\"+d).push(comma());\r\n\t\t\t} else {\r\n\t\t\t\tconst cur = r.peek();\r\n\t\t\t\tif(v == 1 && cur.t !== 6 && cur.t !== 10 && !(cur.t == 4 && (cur.v < 300 || cur.v > 2000))) {\r\n\t\t\t\t\t//console.log(cur.t,cur.v,cur.o);\r\n\t\t\t\t\tr.push(seq());\r\n\t\t\t\t}\r\n\t\t\t\tr.open(tpl);\r\n\t\t\t}\r\n\t\t} else if(v == 3 && state.xml) {\r\n\t\t\tr.open(tpl);\r\n\t\t} else {\r\n\t\t\tr.open(tpl);\r\n\t\t}\r\n\t} else if(t == 2) {\r\n\t\t// FIXME treat all infix-ops in same depth, not just on close\r\n\t\tstate.r.push(tpl).close();\r\n\t\tconst cd = d - 1;\r\n\t\tif(state.call[cd]) {\r\n\t\t\t// $(x)(2) => call($(x),2)\r\n\t\t\tstate.call[cd] = false;\r\n\t\t\t//console.log(\"call\",r.peek());\r\n\t\t\tr.unmark(\"call\"+cd).insertBefore(openParen()).openBefore({t:6,v:\"call\"}).close();\r\n\t\t}\r\n\t\t/*\r\n\t\t* 1 * 2 + 3\r\n\t\t* mult(1,2) + 3\r\n\t\t* 1 + 2 * 3\r\n\t\t* add(1,2) * 3 => pre, so nest in last\r\n\t\t* add(1,2 * 3))\r\n\t\t* add(1,mult(2,3)) => pre, so next in last (we're in subs, so openBefore )\r\n\t\t */\r\n\t\tif(state.infix[d]) {\r\n\t\t\t//console.log(\"peek-close\",_strip(r.peek()));\r\n\t\t\t// mark close so we can return to it\r\n\t\t\tr.mark(\"close\");\r\n\t\t\thandleInfix(state,d);\r\n\t\t\tr.unmark(\"close\");\r\n\t\t\tstate.infix[d] = null;\r\n\t\t}\r\n\t} else if(t == 4){\r\n\t\tif(v == 802 || v == 904 || v == 2005) {\r\n\t\t\tconst last = r.peek();\r\n\t\t\tconst test = last && (last.o || last.v);\r\n\t\t\tconst isEmpty = x => x && Triply.nextSibling(Triply.firstChild(x)) == Triply.lastChild(x);\r\n\t\t\tif(test && ((simpleTypes.includes(test) && isEmpty(last)) || complexTypes.includes(test) || kinds.includes(test))) {\r\n\t\t\t\ttpl.o = opMap[ v + 3000];\r\n\t\t\t\tstate.r.insertAfter(closeParen()).movePreviousSibling().insertBefore(openParen()).openBefore(tpl);\r\n\t\t\t\treturn state;\r\n\t\t\t} else if(last.t == 1 && last.v == 1) {\r\n\t\t\t\tconst prev = r.previous();\r\n\t\t\t\tconst test = prev && prev.o;\r\n\t\t\t\tif(test && complexTypes.includes(test)) {\r\n\t\t\t\t\tif(test == \"function\") {\r\n\t\t\t\t\t\t// convert function(*) to function((...),item()*)\r\n\t\t\t\t\t\tstate.r.push(seq()).open(openParen()).push({t:4,o:\"rest-params\"}).push(closeParen()).close().push(closeParen()).close()\r\n\t\t\t\t\t\t\t.push({t:4,o:\"any\"}).open(openParen()).push({t:4,o:\"item\"}).open(openParen()).push(closeParen()).close()\r\n\t\t\t\t\t\t\t.push(closeParen()).close();\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(v == 505 && hasTag) {\r\n\t\t\t// TODO replace with tag and flag XML at depth\r\n\t\t\tr.pop();\r\n\t\t\tconst qname = state.qname;\r\n\t\t\tstate.qname = null;\r\n\t\t\tif(hasTag == 1) {\r\n\t\t\t\tr.push(openTag(qname,state.attrs));\r\n\t\t\t\tstate.xml++;\r\n\t\t\t\tstate.attrs = [];\r\n\t\t\t} else if(hasTag == 3 || hasTag == 6) {\r\n\t\t\t\tr.push(closeTag(qname));//.close();\r\n\t\t\t}\r\n\t\t\tstate.infix[d]--;\r\n\t\t\treturn state;\r\n\t\t} else if(v == 1901) {\r\n\t\t\tconst last = r.peek();\r\n\t\t\tif(last.t == 4 && last.v == 507) {\r\n\t\t\t\t// close tag\r\n\t\t\t\tif(hasTag) {\r\n\t\t\t\t\tconst qname = state.qname;\r\n\t\t\t\t\tr.pop();\r\n\t\t\t\t\tr.push(openTag(qname,state.attrs));\r\n\t\t\t\t\tr.push(tpl);\r\n\t\t\t\t\tstate.attrs = [];\r\n\t\t\t\t}\r\n\t\t\t\tstate.hasTag = hasTag + 2;\r\n\t\t\t\treturn state;\r\n\t\t\t}\r\n\t\t} else if(v == 2600) {\r\n\t\t\tconst prev = r.previousSibling();\r\n\t\t\tif(prev && prev.t == 1 && prev.v == 3) {\r\n\t\t\t\tprev.v += 2000;\r\n\t\t\t}\r\n\t\t\tconst last = r.peek(1);\r\n\t\t\tr.pop();\r\n\t\t\ttpl.o = last.v;\r\n\t\t} else if(v == 509 && hasTag == 5) {\r\n\t\t\t// NOTE treat attrs as pairs\r\n\t\t\tstate.hasTag = hasTag + 1;\r\n\t\t\treturn state;\r\n\t\t}\r\n\t\tif(v == 119 || v == 2005) {\r\n\t\t\tif(opMap.hasOwnProperty(v)) tpl.o = opMap[v];\r\n\t\t\tr.push(tpl).open(openParen()).push(closeParen()).close();\r\n\t\t} else if(v >= 300 && v < 2000) {\r\n\t\t\t// NOTE always add prefix to distinguish between infix operators and equivalent functions\r\n\t\t\tconst last = r.peek();\r\n\t\t\tconst unaryOp = (v == 801 || v == 802) && (!last || !last.t || last.t == 1 || last.t == 4);\r\n\t\t\tconst v1 = unaryOp ? v + 900 : v;\r\n\t\t\ttpl.v = v1;\r\n\t\t\tconst mappedOp = opMap.hasOwnProperty(v1) ? opMap[v1] : \"n:\"+tpl.o;\r\n\t\t\ttpl.o = mappedOp;\r\n\t\t\tr.push(tpl);\r\n\t\t\tif(!state.infix[d]) state.infix[d] = 0;\r\n\t\t\tr.mark(d+\":\"+state.infix[d]++);\r\n\t\t} else {\r\n\t\t\tr.push(tpl);\r\n\t\t}\r\n\t} else if(t == 6) {\r\n\t\tif(/^\\$/.test(v)) {\r\n\t\t\t// var\r\n\t\t\ttpl.v = v.replace(/^\\$/,\"\");\r\n\t\t\tif(/[0-9]/.test(tpl.v)) tpl.t = 8;\r\n\t\t\tr.push({t:10,v:\"$\",o:\"$\"}).open(openParen()).push(tpl).push(closeParen()).close();\r\n\t\t} else {\r\n\t\t\tconst last = r.peek();\r\n\t\t\tif(last.t == 4 && last.v == 507 && !ws) {\r\n\t\t\t\tstate.qname = v;\r\n\t\t\t\tstate.hasTag = hasTag + 1;\r\n\t\t\t\treturn state;\r\n\t\t\t} else if(hasTag == 4) {\r\n\t\t\t\tstate.hasTag = hasTag + 1;\r\n\t\t\t\tif(!state.attrs) state.attrs = [];\r\n\t\t\t\tstate.attrs.push([v]);\r\n\t\t\t} else {\r\n\t\t\t\tr.push(tpl);\r\n\t\t\t}\r\n\t\t}\r\n\t} else if(t === 0) {\r\n\t\tr.push(tpl);\r\n\t\tif(state.infix[d]) {\r\n\t\t\t// mark close so we can return to it\r\n\t\t\tr.mark(\"EOS\");\r\n\t\t\thandleInfix(state,d);\r\n\t\t\tr.unmark(\"EOS\");\r\n\t\t\tstate.infix[d] = null;\r\n\t\t}\r\n\t} else if(t === 17){\r\n\t\t// mark WS\r\n\t\tstate.ws = true;\r\n\t\tif(hasTag) state.hasTag = 4;\r\n\t} else {\r\n\t\tif(hasTag == 6) {\r\n\t\t\tstate.attrs.lastItem.push(v);\r\n\t\t\tstate.hasTag = 1;\r\n\t\t} else {\r\n\t\t\tr.push(tpl);\r\n\t\t}\r\n\t}\r\n\tstate.depth = tpl.d;\r\n\treturn state;\r\n}\r\n\r\nfunction charReducer(state,next) {\r\n\tconst char = state.char;\r\n\tif(char === undefined) {\r\n\t\tstate.emit = void 0;\r\n\t\tstate.char = next;\r\n\t\treturn state;\r\n\t}\r\n\tif(char == EOF) {\r\n\t\tstate.emit = state.emit && state.tpl.t == 0 ? void 0 : {t:0, v:0, o:EOF};\r\n\t\treturn state;\r\n\t}\r\n\tconst oldType = state.type;\r\n\tconst oldComment = state.comment;\r\n\tconst buffer = state.buffer;\r\n\tconst oldString = state.string;\r\n\t//const oldTpl = state.tpl;\r\n\tconst zero = oldComment || state.qname || state.number ? false : oldString === 0;\r\n\tconst b = buffer + char;\r\n\tconst tmp = zero ? find(state.trie,char,b,state.path) : [[],[]];\r\n\tconst trie = tmp[0];\r\n\tconst path = tmp[1];\r\n\tlet match = 0;\r\n\tif(!trie) {\r\n\t\tmatch = 2;\r\n\t} else if(Array.isArray(trie)) {\r\n\t\tmatch = !trie.length ? 2 : trie[0]._k === b ? 3 : 0;\r\n\t} else if(\"_k\" in trie) {\r\n\t\tmatch = trie._k === b ? 1 : (path.length > 0 && path[0]._k === b) ? 5 : 0;\r\n\t}\r\n\tif(match !== 2) {\r\n\t\tconst tmp = find(trie,next,b + next,[...path]);\r\n\t\tconst trie2 = tmp[0];\r\n\t\tif(trie2 && ((Array.isArray(trie2) && trie2.length > 0) || \"_k\" in trie2)) {\r\n\t\t\t// still a match, stop this one\r\n\t\t\tmatch = 0;\r\n\t\t} else if(match == 3) {\r\n\t\t\t// don't match if char and next ncname\r\n\t\t\tif(trie[0]._v > 4 && ncnameRe.test(char) && ncnameRe.test(next)) {\r\n\t\t\t\tmatch = 2;\r\n\t\t\t}\r\n\t\t\t//match = 0;\r\n\t\t} else if(match === 0) {\r\n\t\t\t// next won't match, so neither will this\r\n\t\t\tmatch = 2;\r\n\t\t}\r\n\t}\r\n\t// NOTE hack for qnames with dash\r\n\tif(next == \"-\" && match == 1 && ncnameRe.test(char)) {\r\n\t\tmatch = 0;\r\n\t}\r\n\tlet type;\r\n\t// skip anything but closers\r\n\tif(match == 1) {\r\n\t\ttype = trie._v;\r\n\t} else if(match == 3) {\r\n\t\ttype = trie[0]._v;\r\n\t} else if(match == 5) {\r\n\t\ttype = path[0]._v;\r\n\t} else if(/\\s/.test(char)) {\r\n\t\ttype = 10;\r\n\t} else if(/[0-9]/.test(char)) {\r\n\t\ttype = 11;\r\n\t} else if(/[a-zA-Z]/.test(char)) {\r\n\t\ttype = 12;\r\n\t} else {\r\n\t\ttype = 0;\r\n\t}\r\n\tconst isVar = (type == 9 && next != \"(\");\r\n\tif(isVar) {\r\n\t\tmatch = type = 0;\r\n\t}\r\n\tlet number = (zero && (type == 11 || (type == 8 && oldType != 8 && /[0-9]/.test(next)))) || (state.number && (type === 0 || type == 11));\r\n\tlet qname = (zero && !number && type != 10 && match == 2) || (state.qname && type != 10) || isVar;\r\n\tlet stop = (qname && /[^a-zA-Z0-9\\-_:]/.test(next)) || (number && /[^0-9.]/.test(next));\r\n\tlet flag;\r\n\tif(number || qname) {\r\n\t\tflag = 0;\r\n\t} else if(zero) {\r\n\t\tif(type == 6 || type == 7) {\r\n\t\t\tflag = 1; // open string :)\r\n\t\t} else if(type == 2501) {\r\n\t\t\tflag = 3; // open comment :)\r\n\t\t\t//} else if(type == 3 && oldType != 3 && next != \"{\" && opencount[0] > 0) then\r\n\t\t\t//    11 (: open enc-expr, TODO add double curly to TRIE :)\r\n\t\t\t//else if($enc-expr and $type == 4 and $has-quot == 0 and $next ne \"}\") then\r\n\t\t\t//    12 (: close enc-expr, TODO add double curly to TRIE :)\r\n\t\t} else {\r\n\t\t\tflag = 0;\r\n\t\t}\r\n\t} else {\r\n\t\t// for the parser we need at least to escape a single quote char, but it should be handled by the trie :)\r\n\t\tif((oldString == 6 && char == \"\\\"\" && next !== \"\\\"\") || (oldString == 7 && char == \"'\")) {\r\n\t\t\tflag = 2; //(: close string :)\r\n\t\t} else if(oldComment && char == \":\" && next == \")\") {\r\n\t\t\tflag = 4; //(: close comment :)\r\n\t\t\t//else if($attrkey == false() and empty($type) and head($opencount) gt 0) then\r\n\t\t\t//    9\r\n\t\t\t//else if($attrkey and $type == 509 and head($opencount) gt 0) then\r\n\t\t\t//    10\r\n\t\t} else {\r\n\t\t\tflag = 0;\r\n\t\t}\r\n\t}\r\n\tlet tpl;\r\n\tif(!flag) {\r\n\t\tif(stop && type != 9) {\r\n\t\t\ttpl = {t:number ? 8 : 6,v:b};\r\n\t\t} else if(number && type == 8) {\r\n\t\t\t// continue\r\n\t\t} else if(type == 10 && state.type !== 10) {\r\n\t\t\ttpl = {t:17};\r\n\t\t} else if(match != 2 && match !== 0) {\r\n\t\t\tlet t = type == 1 || type == 3 || type == 2001 ? 1 :\r\n\t\t\t\ttype == 2 || type == 4 || type == 2002 ? 2 :\r\n\t\t\t\t\ttype == 100 ? 3 :\r\n\t\t\t\t\t\ttype == 5 ? 0 :\r\n\t\t\t\t\t\t\ttype == 9 ? 10 :\r\n\t\t\t\t\t\t\t\ttype == 8 ? 13 :\r\n\t\t\t\t\t\t\t\t\t4;\r\n\t\t\ttpl = {t:t,v:type,o:b};\r\n\t\t}\r\n\t} else if(flag == 2 || flag == 4) {\r\n\t\ttpl = {t:flag == 2 ? 7 : 9,v:buffer};\r\n\t}\r\n\t// if the result is an array, it was expanded\r\n\t// in this case, emit will be overridden by process...\r\n\t// we should only just buffer 2 levels of depth:\r\n\t// one for the type and one for the occurrence indicator...\r\n\tif((zero && type == 10 && buffer == \"\") || tpl || flag) {\r\n\t\tstate.buffer = \"\";\r\n\t} else {\r\n\t\tstate.buffer = b;\r\n\t}\r\n\tif(qname) state.lastQname = tpl;\r\n\t// FIXME hack to skip a char\r\n\tstate.char = flag == 4 ? void 0 : next;\r\n\tstate.number = number && !stop;\r\n\tstate.qname = qname && !stop;\r\n\tstate.type = type;\r\n\tif(tpl) {\r\n\t\ttpl.line = state.line;\r\n\t\ttpl.column = state.column;\r\n\t\tstate.tpl = tpl;\r\n\t}\r\n\tstate.emit = tpl;\r\n\tlet newline = false;\r\n\tif(char == \"\\n\") newline = true;\r\n\tif(newline) {\r\n\t\tstate.line++;\r\n\t\tstate.column = 1;\r\n\t} else {\r\n\t\tstate.column++;\r\n\t}\r\n\r\n\tstate.trie = match > 0 ? ops : trie;\r\n\tstate.path = match > 0 ? [] : path;\r\n\tif(flag == 1) {\r\n\t\tstate.string = type;\r\n\t} else if(flag == 2) {\r\n\t\tstate.string = 0;\r\n\t} else if(flag == 3) {\r\n\t\tstate.comment = true;\r\n\t} else if(flag == 4) {\r\n\t\tstate.comment = false;\r\n\t}\r\n\treturn state;\r\n}\r\n\r\nfunction toRdl($o,entry) {\r\n\tconst { t, v, o } = entry;\r\n\tif(t === 0) {\r\n\t\t$o.next(o === EOF ? \"\" : \";\\n\\n\");\r\n\t} else if(t == 7) {\r\n\t\t$o.next(`\"${v}\"`);\r\n\t} else if(t == 6 || t == 8) {\r\n\t\t$o.next(v);\r\n\t} else if(t == 9) {\r\n\t\t$o.next(\"(:\"+v+\":)\");\r\n\t} else if(t == 11) {\r\n\t\tlet s = \"<\"+v;\r\n\t\tfor(let [k,v] of entry.a) {\r\n\t\t\ts += \" \"+k+\"=\\\"\"+v+\"\\\"\";\r\n\t\t}\r\n\t\ts += \">\";\r\n\t\t//s += next.t == 12 ? \"/>\" : \">\";\r\n\t\t$o.next(s);\r\n\t} else if(t == 12) {\r\n\t\t$o.next(\"</\"+v+\">\");\r\n\t} else if(t == 4 && v == 2600) {\r\n\t\t$o.next(\"\\\"\"+o+\"\\\":\");\r\n\t} else if(o){\r\n\t\t$o.next(o);\r\n\t}\r\n\treturn $o;\r\n}\r\n\r\n\r\nfunction toL3(ret,entry,next){\r\n\tlet $t = entry.t;\r\n\tlet $v = entry.v;\r\n\tlet r = [];\r\n\tif($t == 1) {\r\n\t\tif($v == 3) {\r\n\t\t\tr = [15];\r\n\t\t} else if($v == 2001) {\r\n\t\t\tr = [5];\r\n\t\t} else if($v == 2003) {\r\n\t\t\tr = [6];\r\n\t\t}\r\n\t} else if($t == 2) {\r\n\t\tr = [17];\r\n\t} else if($t == 7) {\r\n\t\tr = [3,$v];\r\n\t} else if($t == 8) {\r\n\t\tif(/^\\./.test($v)) $v = \"0\" + $v;\r\n\t\tr = [12,$v];\r\n\t} else if($t == 6) {\r\n\t\tif(/#[0-9]$/.test($v)) {\r\n\t\t\tr = [4,$v+\"\"];\r\n\t\t} else {\r\n\t\t\tr = next && next.t == 1 && next.v == 1 ? [14,$v] : [3,$v];\r\n\t\t}\r\n\t} else if($t == 4 || $t == 10) {\r\n\t\tif($v == 2600) {\r\n\t\t\tr = [2,entry.o];\r\n\t\t} else {\r\n\t\t\tr = [14,entry.o];\r\n\t\t}\r\n\t} else if($t == 5) {\r\n\t\tr = [3,$v];\r\n\t} else if($t == 9) {\r\n\t\tr = [8,$v];\r\n\t} else if($t == 11) {\r\n\t\tr = [1,$v];\r\n\t\tfor(let [k,v] of entry.a) {\r\n\t\t\tr = r.concat([2,k,3,v]);\r\n\t\t}\r\n\t} else if($t == 12) {\r\n\t\tr = [17];\r\n\t} else if($t == 13) {\r\n\t\tr = [14,\"$.\",17];\r\n\t}\r\n\t//return r ? ret.concat(r) : ret;//Observable.from(r) : Observable.empty();\r\n\tfor(let a of r) ret.next(a);\r\n\treturn ret;\r\n}\r\n\r\nexport const tokenize = state => $chars => {\r\n\treturn Observable.create($o => {\r\n\t\t$chars.subscribe({\r\n\t\t\tnext(cur) {\r\n\t\t\t\tcharReducer(state,cur);\r\n\t\t\t\tif(state.emit) {\r\n\t\t\t\t\t//console.log(state.emit);\r\n\t\t\t\t\t$o.next(state.emit);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcomplete() {\r\n\t\t\t\tcharReducer(state,EOF);\r\n\t\t\t\tif(state.emit) $o.next(state.emit);\r\n\t\t\t\tcharReducer(state);\r\n\t\t\t\tif(state.emit) $o.next(state.emit);\r\n\t\t\t\t$o.complete();\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\t//return $chars.scan((state,cur) => charReducer(state,cur),state).filter(state => state.emit).map(state => state.emit);\r\n};\r\n\r\nconst initLexerState = () => {\r\n\treturn {\r\n\t\temit:false,\r\n\t\tdepth:0,\r\n\t\tr:new Triply(),\r\n\t\tcall:[],\r\n\t\tinfix:[],\r\n\t\txml:0,\r\n\t\tws:false,\r\n\t\thasTag:0,\r\n\t\tqname:null\r\n\t};\r\n};\r\n\r\nexport const lex = props => $tpls => {\r\n\tconst rdl = props.rdl;\r\n\tconst src = props.src;\r\n\tlet state = initLexerState();\r\n\treturn Observable.create($o => {\r\n\t\t$tpls.subscribe({\r\n\t\t\tnext(tpl){\r\n\t\t\t\tconst r = state.r;\r\n\t\t\t\tlet depth = state.depth;\r\n\t\t\t\tif(tpl.t == 2) {\r\n\t\t\t\t\tdepth--;\r\n\t\t\t\t\tif(depth < 0) {\r\n\t\t\t\t\t\tthrow new Error(\"Incorrect depth of close\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!state.tpl || state.tpl.t == 3) throw new Error(\"Incorrect position of close\");\r\n\t\t\t\t} else if(tpl.t == 1) {\r\n\t\t\t\t\t//state.i[depth] = r.length;\r\n\t\t\t\t\tdepth++;\r\n\t\t\t\t}\r\n\t\t\t\ttpl.d = depth;\r\n\t\t\t\t//console.log(depth,tpl);\r\n\t\t\t\tstate = process(tpl,state);\r\n\t\t\t\tstate.tpl = tpl;\r\n\t\t\t\t// never emit tpl, oldTpl can be overriden\r\n\t\t\t\tif(tpl.t === 0) {\r\n\t\t\t\t\tif(depth !== 0){\r\n\t\t\t\t\t\t//console.log(tpl);\r\n\t\t\t\t\t\tthrow new Error(\"Incorrect depth at EOF\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//log(r);\r\n\t\t\t\t\tr.moveRoot().pop();\r\n\t\t\t\t\tif(src) {\r\n\t\t\t\t\t\treturn reduce(r.traverse(true),(a,x) => {\r\n\t\t\t\t\t\t\ta.next(x);\r\n\t\t\t\t\t\t\treturn a;\r\n\t\t\t\t\t\t},$o);\r\n\t\t\t\t\t} else if(rdl) {\r\n\t\t\t\t\t\treduceAhead(r.traverse(),toRdl,$o);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treduceAhead(r.traverse(),toL3,$o);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tstate.r = new Triply();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tcomplete(){\r\n\t\t\t\t$o.complete();\r\n\t\t\t}});\r\n\t});\r\n};\r\n\r\nexport const initTokenState = () => {\r\n\treturn {\r\n\t\ttype:0,\r\n\t\tbuffer:\"\",\r\n\t\tstring:0,\r\n\t\tflag:0,\r\n\t\ttrie:ops,\r\n\t\tnumber:false,\r\n\t\tcomment:false,\r\n\t\tqname: false,\r\n\t\tline: 1,\r\n\t\tcolumn: 1,\r\n\t\tpath: [],\r\n\t\ttpl: {},\r\n\t\temit:void 0\r\n\t};\r\n};\r\n\r\nexport const parse = (path,props = {}) => fromReadStream(path).pipe(mergeMap(chunk => from(chunk.toString())),tokenize(initTokenState()),lex(props));\r\n\r\nexport const parseString = (str,props = {}) => from(str).pipe(tokenize(initTokenState()),lex(props));\r\n"],"file":"parser.js"}